var Application=Class.extend({init:function(){this.initialised=false;this.scorm=new Scorm;this.structure=new Structure;this.session=new Session;this.sequence=new Sequence;this.currentPage={};this.panels={};this.textSize="normal";this.dimensions={layout:"fixed",width:990,height:550};this.navigation="left";this.environment=this.checkEnvironment();this.role="";this.debug=false},start:function(){var l_environment="",l_fragment=document.URL.split(".")[0].replace("http://",""),l_classes=[];this.$body=$("body");this.$page=$("#page");this.$header=$("#header");this.$content=$("#content");this.$footer=$("#footer");this.$blocker=$("#blocker");this.$loader=$("#loader");this.$feedback=$("#feedback");switch(l_fragment){case"local":case"dev":l_environment=l_fragment;break}l_classes=["navigation-"+_app.navigation,l_environment];this.$body.addClass(l_classes.join(" "));switch(_app.navigation){case"top":var $buttons=$("#panel-buttons");$buttons.append($buttons.children(".btn-panel").get().reverse());$buttons.find("img").remove();break;case"hamburger":var $hamburger=$$("a","","btn-hamburger").attr("href","#").html($$("i","","icon icon-hamburger-menu"));this.$header.find(".inner").prepend($hamburger);$hamburger.on("click",function(e){e.preventDefault();_app.currentPage.togglePanels()});break}this.resizeContent();this.panels={menu:new PanelMenu,resources:new PanelResources,case_study:new PanelCaseStudy,notes:new PanelNotes,active:"",showing:false,close:function(){var l_active=this.active.replace(/-/g,"_");if(!empty(l_active)){this[l_active].close()}}};var scope=this;this.scorm.connect(function(){scope.structure.build(function(){scope.session.start(function(){scope.ready()})})})},ready:function(){if(_app.debug||_app.session.getUserData("DEBUG")){this.debugMode(true)}this.panels.menu.setup();this.panels.menu.enable();this.panels.notes.enable();var l_caseStudy=this.structure.getCaseStudy(),l_csTitle=l_caseStudy.title||"Case study";if(l_caseStudy){this.panels.case_study.enable();this.panels.case_study.setup(l_caseStudy);$("#btn-case-study").attr("title","Show the "+l_csTitle.toLowerCase()+" panel").find(".label").html(l_csTitle)}if(Number(_app.structure.course.settings.display_disabled_tabs)===0){this.$body.addClass("hide-disabled-tabs")}this.setupPage();this.setupHeader();this.setupFooter();this.setupFeedback();this.sequence.goTo(this.getLocation());$(window).resize(this.resizeContent);_app.$loader.removeClass("initialising")},getLocation:function(){var l_location="",l_url=document.location.href;if(this.scorm.connected&&this.structure.course.settings.resume_session){l_location=this.scorm.retrieve("cmi.core.lesson_location")}if(l_url.indexOf("#")>-1){l_location=l_url.split("#").pop()}if(empty(l_location)){l_location=this.structure.first().id}return l_location},setupPage:function(){$(document).on("click",".glossary-term",this.glossaryHandler)},setupHeader:function(){var scope=this,l_state=0,l_sizes=["text-size-normal","text-size-big","text-size-biggest"],$message=[],$button=[];$("#header-buttons").click(function(p_event){if(p_event.target.nodeName.toLowerCase()=="img"){p_event.target=p_event.target.parentElement}switch(p_event.target.id){case"btn-size-minus":if(l_state>0)l_state--;scope.$body.removeClass(l_sizes.join(" ")).addClass(l_sizes[l_state]);_app.currentPage.resizePage();break;case"btn-size-plus":if(l_state<2)l_state++;scope.$body.removeClass(l_sizes.join(" ")).addClass(l_sizes[l_state]);_app.currentPage.resizePage();break;case"btn-help":scope.showHelp();break;case"btn-exit":$message=$$("div");$button=$$("a","btn-exit-confirm","button",{href:"#",role:"button"});$message.append($$("p").html("Are you sure you want to exit this module?")).append($button.html("Exit module"));scope.modalOverlay("Exit module",$message,"small","Cancel");$button.click(function(p_event){p_event.preventDefault();scope.sequence.exit()});break}p_event.preventDefault()})},setupFooter:function(){var scope=this,$navigation=this.$footer.find("#page-navigation"),l_copyright=this.structure.course.copyright||"",$back=[],$next=[];this.$footer.find("#copyright").html($$("p").html(l_copyright));$back=$$("a","btn-page-navigation-back","button").html("Back").attr({href:"#",role:"button",title:"Go to the previous page"});$next=$$("a","btn-page-navigation-next","button").html("Next").attr({href:"#",role:"button",title:"Go to the next page"});$navigation.append($back).append($$("span","","page-navigation-position")).append($next);$(document).on("click","#btn-page-navigation-back",function(p_event){scope.panels.close();scope.sequence.back();p_event.preventDefault()});$(document).on("click","#btn-page-navigation-next",function(p_event){scope.sequence.next();scope.panels.close();p_event.preventDefault()})},setupFeedback:function(){var $document=$(document),$feedbackFooter=_app.$feedback.find(".feedback-footer"),$feedbackBtn=$feedbackFooter.find(".btn-feedback"),$enabled=[];this.$feedback.click(this.feedbackHandler);this.$feedback.bind("show",function(){_app.$feedback.find("#feedback-content").removeAttr("style");_app.$feedback.addClass("open").removeAttr("style").slideDown(200,function(){_app.$feedback.findFirstText().attr({tabindex:"-1"}).focus();$("#content, #panel-buttons").disableFocus()});_app.$blocker.addClass("feedback").fadeIn().bind("click.feedbackMinimise",function(){_app.$feedback.trigger("minimise")});$document.bind("keyup.feedback",function(e){if(e.keyCode==27)_app.$feedback.trigger("minimise")})}).bind("hide",function(e,$element){_app.$feedback.find(".feedback-button").removeAttr("style");_app.$blocker.hide().removeClass("feedback");_app.$feedback.removeClass("open").slideUp(200,function(){$("#content, #panel-buttons").enableFocus();if(!$element){$element=_app.$content.find("#question");if(!$element.length){$element=_app.$content.findFirstText()}}if(!$element.is)$element=$($element);$element.attr("tabindex","-1").focus().removeAttr("tabindex")});_app.$blocker.unbind("click.feedbackMinimise");$document.unbind("keyup.feedback")}).bind("maximise",function(){_app.$blocker.addClass("feedback").fadeIn();_app.$feedback.addClass("open").find("#feedback-content").slideDown(200,function(){$enabled.show();$feedbackBtn.removeAttr("style");_app.$feedback.findFirstText().attr({tabindex:"-1"}).focus();$("#content, #panel-buttons").disableFocus()});_app.$blocker.bind("click.feedbackMinimise",function(){_app.$feedback.trigger("minimise")});$document.bind("keyup.feedback",function(e){if(e.keyCode==27)_app.$feedback.trigger("minimise")});$feedbackBtn.unbind("click.feedbackMaximise")}).bind("minimise",function(e,$element){$enabled=$feedbackFooter.find(".feedback-button:visible");_app.$blocker.fadeOut(400,function(){_app.$blocker.removeClass("feedback")});_app.$feedback.removeClass("open").find("#feedback-content").slideUp(200,function(){$feedbackFooter.find(".feedback-button").removeAttr("style");$feedbackBtn.show().bind("click.feedbackMaximise",function(){_app.$feedback.trigger("maximise")});if($element){$element.focus()}else{_app.$content.findFirstText().attr("tabindex","-1").focus()}$("#content, #panel-buttons").enableFocus()});_app.$blocker.unbind("click.feedbackMinimise");$document.unbind("keyup.feedback")})},showHelp:function(){var l_items=$.makeArray(_app.structure.course.resources.help.item),l_count=l_items.length,$overlay=[],l_overlayWidth=0,$help=$$("ul","help-content"),$item=[],$image=[],l_maxW=140,l_newW=0,l_newH=0;for(var i=0;i<l_count;i++){$image=$$("div","","image");if(l_items[i].image!==undefined){if(l_items[i].width>l_maxW){l_newW=l_maxW;l_newH=Math.floor(l_items[i].height/l_items[i].width*l_maxW)}else{l_newW=l_items[i].width;l_newH=l_items[i].height}$image.append($$("img").attr({src:"files/"+l_items[i].image,alt:"",width:l_newW,height:l_newH}))}$item=$$("li","","help-item").append($$("a").attr({href:"#","class":"title custom-input","aria-expanded":"false"}).append(l_items[i].title)).append($$("div","","help-item-content hidden closed").append($image).append($$("div","","text").html(l_items[i].content)));$help.append($item)}$overlay=_app.modalOverlay("Help",$help);l_overlayWidth=$overlay.width();l_overlayWidth=Math.round(l_overlayWidth-l_maxW-60-60-40-20);$overlay.find(".help-item").find(".text").width(l_overlayWidth);$help.find("a.title").bind("click",function(p_event){var $this=$(this),$item=$this.parent();if($item.hasClass("open")){$this.attr({"aria-expanded":"false"});$item.find(".help-item-content").slideUp(function(){$item.removeClass("open")})}else{$this.attr({"aria-expanded":"true"});$item.find(".help-item-content").slideDown(function(){$item.addClass("open")})}p_event.preventDefault()})},glossaryHandler:function(p_event){var $this=$(this),l_glossary=$.makeArray(_app.structure.course.resources.glossary.item),l_count=l_glossary.length,l_term=$this.attr("name"),l_definition="Not found.";for(var i=0;i<l_count;i++){if(l_glossary[i].term==l_term){l_definition=l_glossary[i].definition}}$this.tooltip(l_definition);p_event.preventDefault()},feedbackHandler:function(p_event){var $target=$(p_event.target);if($target.hasClass("feedback-button")){if($target.hasClass("btn-tryagain")){_app.currentPage.resetActivity();_app.$feedback.trigger("hide")}else if($target.hasClass("btn-reset")){_app.currentPage.attempts=0;_app.currentPage.reviewMode=false;_app.currentPage.resetActivity();_app.$feedback.trigger("hide")}else if($target.hasClass("btn-next")){_app.$feedback.trigger("hide");_app.sequence.next()}else if($target.hasClass("btn-findout")){if(_app.currentPage.whyFeedback){_app.currentPage.setupWhy();_app.$feedback.trigger("minimise",_app.$content.find(".btn-why").get(0));setTimeout(function(){$target.removeAttr("style")},1e3)}if(_app.$feedback.hasClass("open")){_app.$feedback.find(".btn-toggle").trigger("click")}}p_event.preventDefault()}},checkEnvironment:function(){var l_host=location.host,l_environment="";switch(l_host.split(".")[0]){case"localhost":l_environment="local";break;case"dev":l_environment="dev";break;default:l_environment="live";break}return l_environment},resizeContent:function(){var $window=$(window),$panels=$("#panels"),$body=this.$body||$("body"),l_marginTop=0,l_marginLeft=0,w_width=$window.width(),w_height=$window.height(),h_width=0,x_outer=0,y_outer=0,$inner=_app.$content.find(".inner"),y_margin=0,x_margin=0;if(window.orientation){switch(window.orientation){case 0:case 180:$body.addClass("portrait");break;default:$body.removeClass("portrait");break}}if(_app.dimensions.layout=="fluid"){l_marginTop=0;l_marginLeft=0;w_width=_app.dimensions.width=$window.width();w_height=_app.dimensions.height=$window.height()}else{l_marginTop=(w_height-_app.dimensions.height)/2;l_marginTop=l_marginTop<0?0:Math.round(l_marginTop);l_marginLeft=(w_width-_app.dimensions.width)/2;l_marginLeft=l_marginLeft<0?0:Math.round(l_marginLeft);w_width=_app.dimensions.width;w_height=_app.dimensions.height}$body.css({position:"absolute",marginTop:l_marginTop,marginLeft:l_marginLeft,width:w_width,height:w_height});h_width=_app.dimensions.width-_app.$header.find("#header-logo").width()-_app.$header.find("#header-buttons").width()-10;_app.$header.find("h1").width(h_width);_app.dimensions.left=l_marginLeft;_app.dimensions.top=l_marginTop;y_outer=_app.$header.find(".inner").eq(0).height()+_app.$footer.outerHeight(true);_app.$content.css({width:w_width-x_outer,height:w_height-y_outer});_app.$content.find("#inner-wrap").css({width:(w_width-x_outer)*2,height:w_height-y_outer});x_margin=parseInt($inner.css("margin-left"),10)+parseInt($inner.css("margin-right"),10);y_margin=parseInt($inner.css("margin-top"),10)+parseInt($inner.css("margin-bottom"),10);$inner.css({width:w_width-x_outer-x_margin,height:w_height-y_outer-y_margin});_app.$blocker.css({width:w_width-x_outer,height:w_height-y_outer});x_outer=130;switch(_app.navigation){case"top":case"hamburger":x_outer=40;break}y_outer=86;$panels.css({width:w_width-x_outer,height:w_height-y_outer}).find(".panel-content").css({height:w_height-y_outer-78});$("#panel-buttons").find(".btn-open").css("left",w_width-x_outer+19+"px");$("#panel-menu").find(".panel-content").css("height",w_height-y_outer-60);if(!empty(_app.currentPage)){_app.currentPage.resizePage()}},modalOverlay:function(p_title,p_content,p_size,p_label,p_callback){var scope=this,$window=$(window),$overlay=$("#modal-overlay"),$title=$overlay.find(".title").find(".inner"),$btnClose=$overlay.find("#btn-overlay-close"),$content=$overlay.find(".content"),l_title=p_title||"",l_content=p_content||"",l_resize=function(){},l_label=p_label||"Close",l_opener=document.activeElement,l_type=_app.currentPage.data.type.split("_").join("-");l_resize=function(){var w_width=scope.dimensions==="fluid"?$window.width():scope.dimensions.width,w_height=scope.dimensions==="fluid"?$window.height():scope.dimensions.height,l_width=w_width-240,l_height=w_height-100,l_left=135,l_top=_app.$header.find(".inner").eq(0).height(),l_titleHeight=$overlay.children(".title").outerHeight(true),y_margin=$content.outerWidth(true)-$content.outerWidth(),x_margin=$content.outerHeight(true)-$content.outerHeight();switch(p_size){case"small":l_width-=240;l_height-=200;l_left=(w_width-l_width)/2;break;case"tall":l_height+=25;break;case"full":l_left=20;l_width=w_width-40;l_height+=25;break;case"mmp":l_width+=90;if(_app.navigation==="top"||_app.navigation==="hamburger"){l_height-=30}break}$overlay.css({width:l_width,height:l_height,top:l_top,left:l_left});$content.css({width:l_width-y_margin,height:l_height-l_titleHeight-x_margin})};$overlay.removeAttr("class").addClass(p_size).addClass(l_type);l_resize();$window.bind("resize.overlay",l_resize);this.$blocker.addClass("modal").fadeIn();$overlay.slideDown(240,function(){$overlay.findFirstText().attr("tabindex","-1").focus();$(document).bind("keyup.closeOverlay",function(e){if(e.keyCode===27){$overlay.trigger("close");e.preventDefault()}});l_resize();if(p_callback)p_callback()});$title.html($$("h3").html(l_title));$content.html(l_content);$btnClose.html(l_label);$("#page, #panel-buttons").disableFocus();$overlay.bind("close",function(){if($("#panels").is(":visible")||_app.$feedback.find("#feedback-content").is(":visible")){scope.$blocker.removeClass("modal")}else{scope.$blocker.removeClass("modal").fadeOut()}$overlay.slideUp(200,function(){$title.empty();$content.empty();$overlay.removeAttr("class")});_app.removePlayers("resource-media","multi-video");$("#page, #panel-buttons").enableFocus();$btnClose.unbind("click");$window.unbind("resize.overlay",l_resize);_app.$blocker.unbind("click.blockerClickModal");$(document).unbind("keyup.closeOverlay");setTimeout(function(){l_opener.focus()},500)});$btnClose.click(function(p_event){$overlay.trigger("close");p_event.preventDefault()});_app.$blocker.bind("click.blockerClickModal",function(){$overlay.trigger("close")});return $overlay},setupVideoPlayer:function(p_selector,p_video){var $body=this.$body,$player=[],$wrap=[],$frame=[],l_player={};$wrap=$$("div","","jwplayer-wrap",{title:"Video player"}).css({position:"relative",width:p_video.width,height:p_video.height});$player=$("#"+p_selector).wrap($wrap);if(Number(p_video.streaming)&&p_video.address.indexOf("vimeo")>-1){$frame=$$("iframe").attr({title:"Vimeo player",src:p_video.address,width:p_video.width,height:p_video.height,frameborder:0,webkitallowfullscreen:1,mozallowfullscreen:1,allowfullscreen:1});if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){$frame.attr("sandbox","allow-same-origin allow-scripts allow-popups")}$player.html($frame);l_player=$f($frame[0]);l_player.vimeo=true;l_player.ready=false;l_player.onReady=function(callback){l_player.addEvent("ready",function(){l_player.ready=true;if(callback)callback()})};l_player.onPlay=function(callback){l_player.addEvent("play",function(){if(callback)callback()})};l_player.onTime=function(callback){l_player.addEvent("playProgress",function(event){event.position=event.seconds;if(callback)callback(event)})};l_player.onSeek=function(callback){l_player.addEvent("seek",function(event){event.offset=Number(event.seconds);if(callback)callback(event)})};l_player.play=function(){l_player.api("play")};l_player.pause=function(){l_player.api("pause")};l_player.seek=function(time){l_player.addEvent("ready",function(){l_player.api("seekTo",time);l_player.play()})};l_player.setFullscreen=function(fullscreen){};l_player.getMute=function(){var volume=l_player.api("getVolume");return volume===0?true:false};l_player.setMute=function(mute){if(mute){l_player.api("setVolume",0)}else{l_player.api("setVolume",.8)}};l_player.resize=function(width,height){$wrap.css({width:width,height:height});$frame.attr({width:width,height:height})};l_player.setPosition=function(time){l_player.play();l_player.api("seekTo",time);l_player.pause()}}else if(Number(p_video.streaming)&&p_video.address.indexOf("youtube")>-1){var l_playerVars={},l_playTimeInt=0,l_event={};if(Number(p_video.force_captions)===0){}else{l_playerVars.cc_load_policy=1}l_playerVars.rel=0;l_playerVars.showinfo=0;l_playerVars.html5=1;l_playerVars.autohide=1;l_player=new YT.Player(p_selector,{height:p_video.height,width:p_video.width,videoId:p_video.address.split("/").pop(),playerVars:l_playerVars});l_player.onReady=function(callback){l_player.addEventListener("onReady",function(){l_player.ready=true;if(callback)callback()})};l_player.onTime=function(callback){l_player.addEventListener("onTime",function(event){if(callback)callback(event)})};l_player.onPlay=function(callback){l_player.addEventListener("onStateChange",function(){if(l_player.getPlayerState()==1){if(callback)callback()}})};l_player.onPause=function(callback){l_player.addEventListener("pause",function(){if(callback)callback()})};l_player.onSeek=function(callback){l_player.addEventListener("seek",function(event){if(callback)callback()})};l_player.play=function(){l_player.playVideo()};l_player.pause=function(){l_player.pauseVideo()};l_player.seek=function(time){l_player.seekTo(time);l_player.playVideo()};l_player.onTime=function(time){l_player.addEventListener("onStateChange",function(){if(l_player.getPlayerState()==1){l_playTimeInt=setInterval(function(){l_event.position=l_player.getCurrentTime();time(l_event)},200)}else{clearInterval(l_playTimeInt)}})};l_player.getMute=function(){};l_player.setMute=function(){};l_player.setFullscreen=function(fullscreen){};l_player.getPosition=function(){return l_player.getCurrentTime()};l_player.setPosition=function(time){l_player.seekTo(time);l_player.pause()}}else{l_player=jwplayer(p_selector).setup({width:p_video.width+"px",height:p_video.height+"px",file:"files/"+p_video.content,modes:[{type:"html5"},{type:"flash",src:"files/player.swf"},{type:"download"}],"controlbar.position":"over","controlbar.idlehide":true,stretching:"fill",repeat:false});l_player.onReady(function(){this.ready=true;this.play();l_player.onBufferFull(function(){if(l_player.getPosition()<1&&l_player.getState()!=="PAUSED"){l_player.pause()}});if(l_player.getState()==="PLAYING"){l_player.pause()}}).onComplete(function(){l_player.seek(0);l_player.pause()}).onFullscreen(function(){if(this.getFullscreen()){$body.addClass("fullscreen")}else{$body.removeClass("fullscreen")}});l_player.setPosition=function(time){l_player.play();l_player.seek(time);l_player.pause()};l_player.jwplayer=true}l_player.onReady(function(){this.ready=true;$(this.container).attr({"aria-label":"Video Player","aria-describedby":p_selector+"-description",tabindex:"0"}).on("keyup",function(e){switch(e.which){case 13:case 32:if(l_player.getState()==="PLAYING"){l_player.pause()}else{l_player.play()}break}}).find("img").each(function(){if(!this.alt)this.alt=""})});return l_player},setupAudioPlayer:function(p_selector,p_audio,p_image){var $body=this.$body,$selector=$("#"+p_selector),l_player={},l_image=p_image||{},l_height=l_image.content?p_audio.height:24,l_config={};$selector.wrap($$("div","","jwplayer-wrap").css({position:"relative",width:p_audio.width,height:l_height}));l_config={width:l_player.width+"px",height:l_height+"px",file:"files/"+p_audio.content,modes:[{type:"html5"},{type:"flash",src:"files/player.swf"},{type:"download"}],controlbar:"bottom",stretching:"fill"};if(l_image.content){l_config.image="files/"+l_image.content;l_config.controlbar="over";l_config["controlbar.idlehide"]=true}l_player=jwplayer(p_selector).setup(l_config);l_player.onReady(function(){this.ready=true;$(this.container).attr({"aria-label":"Audio Player","aria-describedby":p_selector+"-description",tabindex:"0"}).on("keyup",function(e){switch(e.which){case 13:case 32:if(l_player.getState()==="PLAYING"){l_player.pause()}else{l_player.play()}break}}).find("img").each(function(){if(this.id.indexOf("_jwplayer_display_image")>-1){this.alt=l_image.alt_text||""}else if(!this.alt){this.alt=""}})}).onFullscreen(function(){if(this.getFullscreen()){$body.addClass("fullscreen")}else{$body.removeClass("fullscreen")}});l_player.setPosition=function(time){l_player.play();l_player.seek(time);l_player.pause()};return l_player},pausePlayers:function(){var players=arguments,searching=players.length;$.each(jwplayer.getPlayers(),function(i,player){if(player.ready&&player.getState()==="PLAYING"){if(searching){for(var id in players){if(String(player.id).indexOf(players[id])>-1){player.pause()}}}else{player.pause()}}});_app.$content.find("iframe").each(function(){if(this.src.indexOf("vimeo")>-1){this.contentWindow.postMessage('{"method":"pause"}',"*")}else if(this.src.indexOf("youtube")>-1){this.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}',"*")}})},removePlayers:function(){var players=arguments,searching=players.length;$.each(jwplayer.getPlayers(),function(i,player){if(player.ready){if(searching){for(var id in players){if(String(player.id).indexOf(players[id])>-1){jwplayer.api.destroyPlayer(player.id)}}}else{jwplayer.api.destroyPlayer(player.id)}}});_app.$content.find("iframe").each(function(){if(this.src.indexOf("vimeo")>-1||this.src.indexOf("youtube")>-1){$(this).html("")}})},debugMode:function(debug){if(console){if(debug!==false){this.debug=true;console.log("Debug mode: on");$.loadScript("js/utilities/platform.js",function(){console.log("User environment:",$.platform().description);if(_app.currentPage.id){console.log("User location:",_app.structure.course.id[0],">",_app.currentPage.id)}});_app.session.setUserData(["DEBUG",1])}else{this.debug=false;_app.session.unsetUserData("DEBUG");console.log("Debug mode: off")}}}});