var mp_reflect_and_review=PageType.extend({setup:function(){this.tabIndex=0;this.statementIndex=0;this.initialized=false;var l_tabs=$.makeArray(this.data.tabs.tab),l_count=l_tabs.length,$tabs=$$("div","tab-container").attr({role:"tablist"}),$contents=$$("div","tab-content-container");for(var i=0;i<l_count;i++){$tabs.append($$("a","tab-"+l_tabs[i].type,"tab",{href:"#","data-index":i,role:"tab","aria-controls":"tab-content-"+l_tabs[i].type}).html(l_tabs[i].title));$contents.append(this.setupTabContent(l_tabs[i]))}this.html.append($tabs).append($contents);this._super()},setupTabContent:function(p_tab){var $content=$$("div","tab-content-"+p_tab.type,"tab-content"),$inner=$$("div","","tab-content-inner"),l_statements={},l_count=0,l_options=this.data.options.option,l_optionCount=l_options.length,$options=[],$statements=[],$statementButton=[];$content.attr({role:"tabpanel","aria-labelledby":"tab-"+p_tab.type,"aria-disabled":"true"});switch(p_tab.type){case"intro":$inner.append(p_tab.content);$content.append($inner);$content.append($$("a","","btn btn-continue",{href:"#",role:"button"}).html("Continue"));break;case"reflect":$statements=$$("div","","statement-btns",{role:"tablist"});l_statements=$.makeArray(p_tab.statement);l_count=l_statements.length;for(var i=0;i<l_count;i++){$statementButton=$$("a","","statement-btn").html(i+1);$statementButton.attr({href:"#","data-index":i,role:"tab","aria-controls":"statement-"+i,"aria-label":"Statement "+(i+1)});$statements.append($statementButton);$options=$$("fieldset","activity","options");$options.append($$("legend","","hidden").html("Activity"));for(var j=0;j<l_optionCount;j++){$options.append($$("div","","response option").append($$("label").attr({"for":"s-"+i+"o-"+j}).append(l_options[j])).append($$("radio","s-"+i+"o-"+j,"",{name:"so-"+i,"data-option":j})).append($$("span","","custom-input")))}$inner.append($$("div","statement-"+i,"statement",{"data-index":i,"aria-labelledby":"statement-button-"+i,"aria-disabled":"true"}).append($$("div","","question").html(l_statements[i].question)).append($$("div","","options-container").html($options)).append($$("div","","statement-feedback")))}$content.append($inner);$content.append($statements);$content.append($$("a","","btn btn-continue",{href:"#",role:"button"}).html("Continue"));break;case"review":$inner.append($$("label").attr({"for":"review"}).html(p_tab.question));$inner.append($$("textarea","review").attr({maxlength:4e3}));$content.append($inner);$content.append($$("a","","btn btn-save",{href:"#",role:"button"}).html("Save to My notes"));break}return $content},pageReady:function(){var scope=this,l_userData=_app.session.getUserData(this.id),l_optionData=l_userData?l_userData[2][2]:false,$inner=_app.$content.find(".inner").eq(0),$tabs=$inner.find(".tab"),l_tabs=$.makeArray(this.data.tabs.tab),l_statements=l_tabs[1].statement,$textarea=$inner.find("textarea"),l_comments=_app.session.getComments(this.id),$save=$inner.find(".btn-save");if(l_userData){scope.tabIndex=l_userData[2][0];scope.statementIndex=l_userData[2][1]}if(l_comments.length){$textarea.val(l_comments[0].carriage());$save.html("Notes saved")}this.showTab(scope.tabIndex);$tabs.bind("click",function(e){scope.showTab($(this).data("index"));e.preventDefault()});$inner.find(".statement-btn").bind("click",function(e){scope.showStatement($(this).data("index"));e.preventDefault()});$inner.find(".statement").each(function(i){var $statement=$(this),$options=$statement.find(".option"),$input=[];$options.find("input").bind("change",function(){$options.find(".input-overlay").removeClass("selected");$(this).parent().addClass("selected");$statement.find(".statement-feedback").html(l_tabs[1].statement[i].feedback);scope.updateUserData()});if(l_optionData[i]>-1){$input=$statement.find("input").eq(l_optionData[i]);if($input.length&&!$input.is(":checked")){$input.prop("checked",true).trigger("change")}}});$inner.find(".btn-continue").bind("click",function(e){if(scope.tabIndex===1&&scope.statementIndex<l_statements.length-1){scope.statementIndex++;scope.showStatement(scope.statementIndex)}else{scope.tabIndex++;scope.showTab(scope.tabIndex)}e.preventDefault()});$save.disable().bind("click",function(e){var l_text=$textarea.val();l_comments[0]=l_text.uncarriage();_app.session.setComments(scope.id,l_comments);$save.html("Notes saved").disable();e.preventDefault()});$textarea.bind("keyup",function(){var l_text=$textarea.val();if(l_text.uncarriage()!==l_comments[0]){$save.html("Save to My notes").enable()}else{$save.html("Notes saved").disable()}});this._super()},showTab:function(p_index){var scope=this,$inner=_app.$content.find(".inner").eq(0),$tabs=$inner.find(".tab"),$contents=$inner.find(".tab-content"),$content=[];$tabs.each(function(i){var $this=$(this);$this.removeClass("selected").removeAttr("aria-selected");if(i===p_index){$this.addClass("selected").attr("aria-selected","true")}});$contents.each(function(i){var $this=$(this);$this.removeClass("selected").attr("aria-disabled","true");if(i===p_index){$content=$this.addClass("selected").removeAttr("aria-disabled")}});if(p_index===1){scope.showStatement(scope.statementIndex)}else{if(this.initialized){setTimeout(function(){$content.find("p, textarea").eq(0).attr("tabindex",-1).focus()},200)}else{this.initialized=true}}this.tabIndex=p_index;this.updateUserData()},showStatement:function(p_index){var $inner=_app.$content.find(".inner").eq(0),$tab=$inner.find("#tab-content-reflect"),$statements=$tab.find(".statement"),$statement=[],$btns=$tab.find(".statement-btn");$statements.each(function(i){var $this=$(this);$this.removeClass("selected").attr("aria-disabled","true");if(i===p_index){$statement=$this.addClass("selected").removeAttr("aria-disabled")}});$btns.each(function(i){var $this=$(this);$this.removeClass("selected").removeAttr("aria-selected");if(i===p_index){$this.addClass("selected").attr("aria-selected","true")}});if(this.initialized){setTimeout(function(){$statement.findFirstText().attr("tabindex",-1).focus()},200)}else{this.initialized=true}this.statementIndex=p_index;this.updateUserData()},updateUserData:function(){var l_userData=[this.tabIndex,this.statementIndex],l_statements=[],$statements=_app.$content.find(".statement"),$checked=[],l_checked=-1;$statements.each(function(){$checked=$(this).find("input:checked");l_checked=-1;if($checked.length)l_checked=$checked.data("option");l_statements.push(l_checked)});l_userData.push(l_statements);this.updatePageData([-1,l_userData])},resizePage:function(){var $inner=_app.$content.find(".inner").eq(0),$title=$inner.find(".page-title"),$tabs=$inner.find("#tab-container"),$contents=$inner.find("#tab-content-container");$contents.height($inner.height()-$title.height()-$tabs.height())}});