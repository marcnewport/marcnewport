var mp_drag_drop_scene=PageType.extend({setup:function(){var l_asset=this.data.asset.item,l_hotspots=$.makeArray(this.data.hotspots.item),l_count=l_hotspots.length,l_hotspot={},l_dragId="",l_order=[],$draggables=$$("div","draggables"),$droppable=[],$scene=$$("div","scene"),l_userData=_app.session.getUserData(this.id)[2];$scene.append($$("img").attr({src:"files/"+l_asset.content,alt:l_asset.alt_text,width:l_asset.width,height:l_asset.height}));for(var i=0;i<l_count;i++){l_hotspot=l_hotspots[i];l_dragId=$.randomString(6);l_order[i]=l_dragId;$draggables.append($$("div",l_dragId,"draggable").html(l_hotspot.content));$droppable=$$("div","","droppable").css({left:l_hotspot.left-18+"px",top:l_hotspot.top-18+"px"});$scene.append($droppable)}this.data.order=l_order;this.html.append($$("div","","left-column").append($$("div","","text-content").append(this.data.scenario).append(this.data.question)).append($draggables)).append($$("div","","right-column").append($scene).append($$("a","btn-submit").attr({href:"#",role:"button"}).html("Submit")));this._super();if(l_userData){var l_id="",$droppables=$scene.find(".droppable");for(i=0;i<l_count;i++){l_id=l_order[l_userData[i][0]];$droppables.eq(i).data("draggable",l_id).addClass("dropped");$("#"+l_id).css({position:"relative",left:l_userData[i][1]+"px",top:l_userData[i][2]+"px"})}}},pageReady:function(){var scope=this,$draggables=_app.$content.find("#draggables"),$draggable=$draggables.find(".draggable"),$droppables=_app.$content.find(".droppable"),$submit=$("#btn-submit");$draggable.draggable({revert:"invalid"});$draggables.droppable({tolerance:"intersect",drop:function(p_event,p_ui){var l_id=p_ui.draggable.attr("id");if(l_id){scope.removeDraggable(l_id)}if(scope.submittable()){$submit.enable()}else{$submit.disable()}}});$droppables.droppable({tolerance:"touch",over:function(){$(this).addClass("over")},out:function(){$(this).removeClass("over")},drop:function(p_event,p_ui){var $this=$(this),l_oldId=$this.data("draggable"),l_newId=p_ui.draggable.attr("id"),$draggable=$("#"+l_newId),l_sceneOffset=_app.$content.find("#scene").offset(),l_droppablePosition=$this.position(),l_offset={},l_dropWidth=0,l_dropHeight=0,l_dragWidth=0,l_dragHeight=0,l_newX=0,l_newY=0;if(l_newId){if(l_oldId&&l_oldId!=l_newId){scope.removeDraggable(l_oldId)}$droppables.each(function(){var $this=$(this);if($this.data("draggable")==l_newId){$this.removeClass("dropped").removeData("draggable")}});$this.data("draggable",l_newId);$this.addClass("dropped").removeClass("over");l_offset={left:l_sceneOffset.left+l_droppablePosition.left,top:l_sceneOffset.top+l_droppablePosition.top};l_dropWidth=$this.outerWidth();l_dropHeight=$this.outerHeight();l_dragWidth=$draggable.outerWidth();l_dragHeight=$draggable.outerHeight();l_newX=Math.floor(p_ui.offset.left-(l_offset.left+(l_dropWidth-l_dragWidth)/2));l_newY=Math.floor(p_ui.offset.top-(l_offset.top+(l_dropHeight-l_dragHeight)/2));$draggable.animate({left:"-="+l_newX+"px",top:"-="+l_newY+"px"});if(scope.submittable()){$submit.enable()}else{$submit.disable()}}}});$draggables.bind("touchstart touchmove touchend touchcancel",function(e){var touches=event.changedTouches,first=touches[0],type="",simulatedEvent=document.createEvent("MouseEvent");switch(e.type){case"touchstart":type="mousedown";break;case"touchmove":type="mousemove";break;case"touchend":type="mouseup";break;default:return}simulatedEvent.initMouseEvent(type,true,true,window,1,first.screenX,first.screenY,first.clientX,first.clientY,false,false,false,false,0,null);first.target.dispatchEvent(simulatedEvent);e.stopPropagation();e.preventDefault()});this._super()},removeDraggable:function(p_id){_app.$content.find(".droppable").each(function(){var $this=$(this),l_draggable=$this.data("draggable");if(l_draggable==p_id){$this.removeData("draggable").attr("class","droppable ui-droppable").droppable("option","accept",".draggable");$("#"+p_id).animate({left:0,top:0})}})},submittable:function(){var $droppables=_app.$content.find(".droppable"),l_submittable=true;$droppables.each(function(){if(!$(this).data("draggable")){l_submittable=false;return false}});return l_submittable},submitAnswers:function(){this.attempts++;var scope=this,$droppables=_app.$content.find(".droppable"),l_draggable="",$draggable=[],l_userData=[],l_index=0,l_left=0,l_top=0,l_correct=1,l_lastAttempt=this.attempts>=this.data.max_attempts;_app.$content.find(".draggable").draggable("disable");$("#btn-submit").disable();$droppables.each(function(i){var $this=$(this);l_draggable=$this.data("draggable");$draggable=$("#"+l_draggable);l_index=scope.data.order.indexOf(l_draggable);l_left=parseInt($draggable.css("left"),10);l_top=parseInt($draggable.css("top"),10);l_userData[i]=[l_index,l_left,l_top];if(l_draggable==scope.data.order[i]){$this.addClass("correct");$draggable.addClass("correct")}else{l_correct=0}});if(l_lastAttempt||l_correct){$("#scene").addClass("completed");$("#draggables").addClass("completed");if(!l_correct){_app.$feedback.find(".btn-location").show().click(function(){this.style="";scope.showCorrectOrder();_app.$feedback.trigger("hide")})}}this.updatePageData([l_correct,l_userData,this.attempts])},resetActivity:function(){this._super();var scope=this,l_items=this.data.order,l_count=l_items.length,$submit=_app.$content.find("#btn-submit");for(var i=0;i<l_count;i++){this.removeDraggable(l_items[i])}_app.$content.find("#scene").removeClass("completed");_app.$content.find("#draggables").removeClass("completed");_app.$content.find(".draggable").removeClass("correct").draggable("enable");_app.$content.find(".droppable").bind("drop",function(){$(this).removeClass("correct");if(scope.submittable()){$submit.enable()}else{$submit.disable()}})},showCorrectOrder:function(){var scope=this;_app.$content.find(".droppable").each(function(){var $this=$(this),l_draggable=$this.data("draggable"),$draggable=_app.$content.find("#"+l_draggable),l_dragOffset=$this.offset(),l_droppable=scope.data.order.indexOf(l_draggable),$droppable=_app.$content.find(".droppable").eq(l_droppable),l_dropOffset=$droppable.offset();$draggable.animate({left:"-="+(l_dragOffset.left-l_dropOffset.left)+"px",top:"-="+(l_dragOffset.top-l_dropOffset.top)+"px"})})},resizePage:function(){var $pageTitle=_app.$content.find(".page-title"),$inner=_app.$content.find(".inner"),l_margin=$inner.outerHeight(true)-$inner.outerHeight(),l_outer=$pageTitle.height()+l_margin,$left=_app.$content.find(".left-column"),$text=$left.find(".text-content"),$draggables=$left.find("#draggables"),$right=_app.$content.find(".right-column"),l_height=_app.$content.height(),l_width=_app.$content.find(".inner").width(),l_imageWidth=_app.$content.find("#scene img").attr("width");$left.css({width:l_width-l_imageWidth-12});$text.css({maxHeight:l_height-l_outer-$draggables.outerHeight()-20,overflow:"auto",marginBottom:"20px"});$right.css({width:l_imageWidth})}});