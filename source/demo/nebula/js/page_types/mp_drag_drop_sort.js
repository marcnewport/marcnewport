var mp_drag_drop_sort=PageType.extend({setup:function(){var l_targets=$.makeArray(this.data.targets.item),l_targetData=[],l_targetCount=l_targets.length,$targets=$$("div","targets"),$targets_drops=$$("div","targets-drops"),$titles=$$("div","target-titles"),$dragables=$$("ul","","draggables",{role:"group"}),$drags=$$("div","drags");this.targetCount=l_targetCount;this.grabbed=[];for(var i=0;i<l_targetCount;i++){l_targetData=l_targets[i];$targets_drops.append($$("div","t_"+i,"target").append($$("ul","","draggables",{title:"Drop target. "+l_targetData.title,tabindex:0,role:"group"})));$titles.append($$("div","","title").html($$("h3").html(l_targetData.title)))}this.html.append($$("div","intro").html(this.data.scenario)).append($$("div","drag-container").append($drags.html($dragables)).append($targets.append($titles.append($$("div","","clear"))).append($targets_drops)).append($$("div","","clear"))).append($$("a","btn-submit").attr({href:"#",role:"button"}).html("Submit"));this._super();this.setUpResponses(true)},pageReady:function(){var l_targetCount=this.targetCount,l_userData=_app.session.getUserData(this.id),$target=[],l_dragData=[],l_dragCount=0,l_responses=[];if($.isArray(l_userData[2])){l_responses=l_userData[2];for(var i=0;i<l_targetCount;i++){l_dragData=l_responses[i]||[];l_dragCount=l_dragData.length;$target=_app.$content.find("#t_"+i).find(".draggables");for(var j=0;j<l_dragCount;j++){_app.$content.find("#"+l_dragData[j]).appendTo($target)}}}this._super()},setupActivity:function(){var scope=this,$draggables=_app.$content.find(".draggables");$draggables.sortable({connectWith:"#content .draggables",containment:"#drag-container",start:function(event,ui){ui.item.addClass("grabbed")},stop:function(event,ui){ui.item.removeClass("grabbed")},receive:function(event,ui){scope.checkCompletion()}});$draggables.bind("touchstart touchmove touchend touchcancel",function(e){var touches=event.changedTouches,first=touches[0],type="",simulatedEvent=document.createEvent("MouseEvent");switch(e.type){case"touchstart":type="mousedown";break;case"touchmove":type="mousemove";break;case"touchend":type="mouseup";break;default:return}simulatedEvent.initMouseEvent(type,true,true,window,1,first.screenX,first.screenY,first.clientX,first.clientY,false,false,false,false,0,null);first.target.dispatchEvent(simulatedEvent);e.stopPropagation();e.preventDefault()});$("#btn-submit").disable();var t_index=0,$targets=_app.$content.find("#targets .draggables"),t_length=$targets.length;_app.$content.bind("keyup.dads",function(e){switch(e.which){case 32:case 13:scope.keyupHandler(e.target);break;case 77:if(e.ctrlKey)scope.keyupHandler(e.target);break;case 39:if(e.target.parentNode.className==="target"){t_index=$(e.target.parentNode).index();if(t_index<t_length-1){t_index+=1;$targets.eq(t_index).focus()}}break;case 37:if(e.target.parentNode.className==="target"){t_index=$(e.target.parentNode).index();if(t_index>0){t_index-=1;$targets.eq(t_index).focus()}}break;case 27:scope.keyupHandler(scope.grabbed);break}})},keyupHandler:function(el){var scope=this,$element=el instanceof $?el:$(el),$drag=$element,$clone=[],e_index=0,e_left=0,$parent=[],p_index=0,$drags=_app.$content.find("#drags"),$targets=_app.$content.find(".target"),transitionendHandler;if($element.hasClass("draggables")){$drag=scope.grabbed;$clone=$drag.clone(true);e_index=$element.parent().index();e_left=(e_index+1)*210;$parent=$drag.parent().parent();if($parent.hasClass("target")){p_index=$parent.index();if(p_index===e_index)return;e_left=(e_index-p_index)*210}transitionendHandler=function(){$element.prepend($clone);$drag.remove();scope.keyupHandler($clone);scope.checkCompletion();setTimeout(function(){$drags.find(".drag-item").eq(0).focus()},1e3)};$drag.css({position:"relative",marginLeft:e_left+"px",transition:"all 0.5s ease-out",zIndex:5}).bind("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",transitionendHandler);if($element.get(0).style.transition===undefined)setTimeout(transitionendHandler,150)}else if($element.hasClass("drag-item")){if($drag.length){if($drag.data("grabbed")){scope.grabbed=[];$drag.data("grabbed",false).attr({"aria-grabbed":false}).removeClass("grabbed");$targets.removeAttr("aria-dropeffect")}else{if(scope.grabbed.length){scope.grabbed.data("grabbed",false).attr({"aria-grabbed":false}).removeClass("grabbed")}$drag.data("grabbed",true).attr({"aria-grabbed":true}).addClass("grabbed");scope.grabbed=$drag;setTimeout(function(){$targets.find(".draggables").attr("aria-dropeffect","copy move").eq(0).focus()},1e3)}}}},setUpResponses:function(){var $drags=_app.$content.find("#drags").find(".draggables"),$targets=_app.$content.find("#targets"),l_dragItems=$.makeArray(this.data.draggables.item),l_dragData=[],l_dragCount=l_dragItems.length,l_drag_id="";$drags.empty();$targets.find(".target").find(".draggables").empty();for(var i=0;i<l_dragCount;i++){l_dragData=l_dragItems[i];l_drag_id="d_"+i;$drags.append($$("li",l_drag_id,"drag-item",{tabindex:0,role:"listitem","aria-grabbed":false,"data-index":i}).html(l_dragData.label))}this.setupActivity()},checkCompletion:function(){if(_app.$content.find("#drags").find(".drag-item").length){$("#btn-submit").disable()}else{$("#btn-submit").enable()}},submitAnswers:function(){var scope=this,$targets=_app.$content.find("#targets"),l_activityCorrect=1,l_userData=[],l_dragItems=$.makeArray(this.data.draggables.item),l_dragData=[],l_dragCount=l_dragItems.length,$drag_item=[],l_dragItemId="",l_targetID="",l_finalRound=this.attempts==this.data.max_attempts-1?true:false,l_count=0,l_correctCount=0;_app.$content.find("#btn-submit").disable();_app.$content.find(".draggables").sortable("disable");_app.$content.find(".target ul, .drag-item").removeAttr("tabindex");for(var i=0;i<l_dragCount;i++){l_dragItemId="d_"+i;$drag_item=$targets.find("#"+l_dragItemId);l_dragData=l_dragItems[i];l_targetID=$drag_item.parents(".target").attr("id").split("_")[1];if(l_targetID==Number(l_dragData.target)-1){l_correctCount++;$drag_item.addClass("correct")}else{l_activityCorrect=0;$drag_item.addClass("incorrect")}if(!l_userData[l_targetID]){l_userData[l_targetID]=[]}l_userData[l_targetID].push(l_dragItemId)}this.attempts++;this.updatePageData([Number(l_activityCorrect),l_userData,this.attempts]);if(l_finalRound||l_correctCount===l_count){$targets.addClass("final");$("#btn-page-navigation-next").enable();if(!l_activityCorrect){_app.$feedback.find(".btn-categories").show().click(function(){this.style="";scope.showCorrectOrder();_app.$feedback.trigger("hide")})}}},showCorrectOrder:function(){var l_items=$.makeArray(this.data.draggables.item);_app.$content.find(".drag-item").each(function(){var $this=$(this),$clone=[],l_target=0;if($this.hasClass("incorrect")){$clone=$this.clone().hide();l_target=l_items[$this.data("index")].target-1;$this.fadeOut(1e3);$("#t_"+l_target).find("ul").append($clone.fadeIn(1e3))}})},resetActivity:function(){this._super();var l_userData=_app.session.getUserData(),$targets=_app.$content.find("#targets");$targets.removeClass("final");$targets.find(".drag-item").removeClass("correct");_app.$content.find(".draggables").sortable("enable");_app.$content.find(".target ul, .drag-item").attr("tabindex",0);if(this.attempts===0||this.attempts===this.data.max_attempts||l_userData[1]){$("#content .draggables").sortable("destroy");this.setUpResponses()}},resizePage:function(){var $inner=_app.$content.find(".inner").eq(0),$pageTitle=$inner.find(".page-title"),$intro=$inner.find("#intro"),$container=$inner.find("#drag-container"),$titles=$container.find("#target-titles"),$submit=$inner.find("#btn-submit"),l_height=$inner.height()-$pageTitle.height()-$intro.outerHeight(true)-$submit.outerHeight(true);$container.height(l_height)}});