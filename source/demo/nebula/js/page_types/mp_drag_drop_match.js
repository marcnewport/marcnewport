var mp_drag_drop_match=PageType.extend({setup:function(){var l_targets=$.makeArray(this.data.targets.item),l_targetData=[],l_targetCount=l_targets.length,$targets=$$("div","targets");this.targetCount=l_targetCount;this.userData={};for(var i=0;i<l_targetCount;i++){l_targetData=l_targets[i];$targets.append($$("div","t_"+i,"item").append($$("div","q_"+i,"question").append($$("div","","question-top").append($$("div","","question-mid").html(l_targetData.title)))).append($$("div","","target")))}this.html.append($$("div","main-text").html(this.data.scenario)).append($$("div","drag-container").append($targets).append($$("div","drags"))).append($$("a","btn-submit").attr({href:"#",role:"button"}).html("Submit"));this._super();this.setUpResponses()},pageReady:function(){var l_targetCount=this.targetCount,$attachTo=[],$drag_item=[],l_position=[],l_userData=_app.session.getUserData(this.id);if(l_userData[2]!=undefined){this.userData=l_userData[2]}for(var i=0;i<l_targetCount;i++){if(l_userData[2]!=undefined){$attachTo=_app.$content.find("#"+l_userData[2]["d_"+i].attached_to);l_position=$attachTo.position();$drag_item=_app.$content.find("#"+"d_"+i);$drag_item.css({top:l_position.top+"px",left:l_position.left+294+"px","margin-left":0}).addClass("placed")}else{this.userData["d_"+i]={};this.userData["d_"+i].attached_to="c_"+i}}this._super()},setupActivity:function(){var l_userData=this.userData,l_targetCount=this.targetCount,$draggable=$(".drag-item"),$target=[],l_index="",l_targetIndex="",$drag_item=[],l_position=[],l_top=0,l_left=0,$container=[],l_containerPosition=[],l_moveTo="",l_allPlaced=true;if(_app.session.getUserData(this.id)[2]){l_userData=_app.session.getUserData(this.id)[2]}$draggable.draggable({containment:"#drag-container"});$(".item").droppable({drop:function(event,ui){var $this=$(this);$target=$this.find(".target");l_targetIndex=$this.attr("id").split("_")[1];$drag_item=ui.draggable;l_index=$drag_item.attr("id").split("_")[1];if($this.hasClass("ui-droppable")){l_position=$this.position();l_top=l_position.top;l_left=l_position.left+294;$drag_item.animate({top:l_top+"px",left:l_left+"px","margin-left":0},400,function(){l_userData["d_"+l_index].attached_to="t_"+l_targetIndex;$drag_item.addClass("placed");l_allPlaced=true;for(var t=0;t<l_targetCount;t++){if(l_userData["d_"+t].attached_to.split("_")[0]!="t"){l_allPlaced=false;break}}if(l_allPlaced){$("#btn-submit").enable()}else{$("#btn-submit").disable()}});for(var i=0;i<l_targetCount;i++){if(l_userData["d_"+i].attached_to=="t_"+l_targetIndex&&i!=l_index){l_moveTo=l_userData["d_"+l_index].attached_to;if(l_moveTo.split("_")[0]=="t"){l_moveTo="c_"+l_moveTo.split("_")[1]}$container=_app.$content.find("#"+l_moveTo);l_containerPosition=$container.position();_app.$content.find("#d_"+i).animate({top:l_containerPosition.top+"px",left:l_containerPosition.left+"px"},400,function(){$(this).removeClass("placed")});l_userData["d_"+i].attached_to=l_moveTo;break}if(l_userData["d_"+i].attached_to=="c_"+l_targetIndex&&i!=l_index){l_moveTo="c_"+l_userData["d_"+l_index].attached_to.split("_")[1];$container=_app.$content.find("#"+l_moveTo);l_containerPosition=$container.position();_app.$content.find("#d_"+i).animate({top:l_containerPosition.top+"px",left:l_containerPosition.left+"px"});l_userData["d_"+i].attached_to=l_moveTo}}this.userData=l_userData}}});this.userData=l_userData;$draggable.bind("touchstart touchmove touchend touchcancel",function(e){var touches=event.changedTouches,first=touches[0],type="",simulatedEvent=document.createEvent("MouseEvent");switch(e.type){case"touchstart":type="mousedown";break;case"touchmove":type="mousemove";break;case"touchend":type="mouseup";break;default:return}simulatedEvent.initMouseEvent(type,true,true,window,1,first.screenX,first.screenY,first.clientX,first.clientY,false,false,false,false,0,null);first.target.dispatchEvent(simulatedEvent);e.stopPropagation();e.preventDefault()});$("#btn-submit").disable()},setUpResponses:function(p_reset){var $drags=_app.$content.find("#drags"),$targets=_app.$content.find("#targets"),$question=[],$drag_mid=[],$drag_item=[],l_maxHeight=50,l_paddingMin=11,l_padding=0,l_dragItems=$.makeArray(this.data.draggables.item),l_dragData=[],l_targetCount=this.targetCount,l_drag_id="",l_classes="";$drags.empty();$targets.find(".target").removeClass("correct").removeClass("placed");for(var i=0;i<l_targetCount;i++){l_dragData=l_dragItems[i];l_drag_id="d_"+i;l_classes="drag-item";if(i%2)l_classes+=" odd";if(p_reset)this.userData[l_drag_id].attached_to="c_"+i;$drags.append($$("div",l_drag_id,l_classes).css("top",55*i+"px").append($$("div","","drag-item-point")).append($$("span","","icon icon-tick")).append($$("div","","drag-item-mid").html(l_dragData.label))).append($$("div","c_"+i,"container").css("top",55*i+"px"))}for(var q=0;q<l_targetCount;q++){$question=_app.$content.find("#t_"+q).find(".question-mid");$drag_item=_app.$content.find("#d_"+q);$drag_mid=$drag_item.find(".drag-item-mid");l_padding=(l_maxHeight-$question.height())/2;if(l_padding<l_paddingMin)l_padding=l_paddingMin;$question.css({paddingTop:Math.floor(l_padding)+"px"});l_padding=(l_maxHeight-$drag_mid.height())/2;if(l_padding<l_paddingMin)l_padding=l_paddingMin;$drag_mid.css({paddingTop:Math.ceil(l_padding-1)+"px",paddingBottom:Math.floor(l_padding-1)+"px"})}this.setupActivity()},submitAnswers:function(){var scope=this,l_userData=this.userData,l_targetCount=this.targetCount,l_dragItems=$.makeArray(this.data.draggables.item),$drag_item=[],l_id="",l_activityCorrect=true,l_targetIndex=0,l_finalRound=this.attempts==this.data.max_attempts-1?true:false,l_correctCount=0;for(var i=0;i<l_targetCount;i++){l_id="d_"+i;$drag_item=_app.$content.find("#"+l_id);l_targetIndex=l_userData[l_id].attached_to.split("_")[1];if(Number(l_dragItems[i].target)!=Number(l_targetIndex)+1){l_activityCorrect=false}else{$drag_item.addClass("correct");l_correctCount++}}this.attempts++;this.updatePageData([Number(l_activityCorrect),this.userData,this.attempts]);if(l_finalRound){$("#drags").addClass("final").find(".drag-item").draggable("disable");$("#btn-submit").disable();if(!l_activityCorrect){_app.$feedback.find(".btn-show").show().click(function(){this.style="";scope.showCorrectOrder();_app.$feedback.trigger("hide")})}}},showCorrectOrder:function(){var l_dragItems=$.makeArray(this.data.draggables.item);$("#drags").find(".drag-item").each(function(i){var l_position=Number(l_dragItems[i].target)-1;$(this).addClass("ordered").animate({top:l_position*55},1e3)})},resetActivity:function(){this._super();var l_userData=_app.session.getUserData(),$drag_items=_app.$content.find(".drag-item");$drag_items.removeClass("correct");if(this.attempts===0||this.attempts===this.data.max_attempts||l_userData[1]){$("#content .draggables").sortable("destroy");this.setUpResponses(true)}},resizePage:function(){var $inner=_app.$content.find(".inner"),$title=_app.$content.find(".page-title"),$text=_app.$content.find("#main-text"),$drag=_app.$content.find("#drag-container"),$submit=_app.$content.find("#btn-submit");$text.css({maxHeight:$inner.height()-$title.outerHeight(true)-$drag.outerHeight(true)-$submit.outerHeight(true),overflow:"auto"})}});