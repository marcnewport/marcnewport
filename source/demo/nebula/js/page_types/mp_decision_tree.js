var mp_decision_tree=PageType.extend({setup:function(){this._super();this.linkClicked="";this.decisionPoint="";this.html.append($$("div","activity")).append($$("div","decision-navigation").append($$("a").attr({"class":"btn-restart",title:"Start from the first decision point"}).html("Restart")).append($$("a").attr({"class":"btn-previous",title:"Go back to the last decision point"}).html("Previous")).append($$("a").attr({"class":"btn-more",title:"View the resource"}).html("More")))},pageReady:function(){var l_decisionPoints=$.makeArray(_app.currentPage.data.decision_points.item),l_lastId="",l_lastData={};this.userData=_app.session.getUserData(this.id)[2]||[];if(this.userData.length){l_lastId=this.userData[this.userData.length-1];l_lastData=this.getDecisionPointData(l_lastId);this.showDecisionPoint(l_lastData)}else{this.showDecisionPoint(l_decisionPoints[0])}this._super()},showDecisionPoint:function(p_data){var scope=this,$image=$$("div","background-image"),l_hotspots=$.makeArray(p_data.hotspots.item),l_count=l_hotspots.length,l_hotspot={},$hotspot=[],l_image=new Image;this.decisionPoint=p_data.id;this.linkClicked="";this.hideDecisionButtons();$image.append($$("img").attr({src:"files/"+p_data.background_image.item.content,alt:"",width:p_data.background_image.item.width,height:p_data.background_image.item.height}));$image.hide();for(var i=0;i<l_count;i++){$hotspot=$$("a",l_hotspots[i].id,"hotspot",{href:"",title:l_hotspots[i].title}).css({top:l_hotspots[i].top+"px",left:l_hotspots[i].left+"px"}).html($$("span","","icon icon-compass"));$image.append($hotspot)}l_image.src="files/"+p_data.background_image.item.content;l_image.onload=function(){_app.$content.find("#activity").html($image);$image.fadeIn(600);scope.showIntroText(p_data)};$image.find(".hotspot").click(function(p_event){for(var i=0;i<l_count;i++){if(this.id==l_hotspots[i].id){l_hotspot=l_hotspots[i];break}}if(_app.$feedback.hasClass("closed")){_app.$feedback.trigger("hide");scope.showFeedback(l_hotspot);_app.$feedback.find(".tab").trigger("click")}else{_app.$feedback.fadeOut(600,function(){_app.$feedback.trigger("hide");scope.showFeedback(l_hotspot)})}$(this).addClass("selected");p_event.preventDefault()});if(p_data.id!=this.userData[this.userData.length-1]){this.userData.push(p_data.id);_app.session.setUserData([this.id,-1,this.userData])}},showIntroText:function(p_data){var scope=this,$feedbackText=_app.$feedback.find("#feedback-txt");if(p_data.introduction_text){_app.$feedback.find(".feedback-button").unbind("click");$feedbackText.html("<h4>"+p_data.title+"</h4>"+p_data.introduction_text);if(this.userData.length>1){_app.$feedback.find(".btn-feedback-restart").show().click(scope.restartDecision);_app.$feedback.find(".btn-feedback-previous").show().click(scope.previousDecision)}if(p_data.resource){var l_param={resource:p_data.resource};_app.$feedback.find(".btn-feedback-more").show().click(l_param,scope.showResource)}if($.makeArray(p_data.hotspots.item).length<1){this.decisionsComplete()}_app.$feedback.find(".btn-feedback-hide").show().click(function(e){_app.$feedback.trigger("minimise");e.preventDefault()});_app.$feedback.fadeIn()}else{this.showDecisionButtons(p_data)}},showDecisionButtons:function(p_data){var scope=this,$navigation=$("#decision-navigation");$navigation.find(".btn-restart").show().click(scope.restartDecision);$navigation.find(".btn-previous").show().click(scope.previousDecision);if(p_data.resource){var l_param={resource:p_data.resource};$navigation.find(".btn-more").show().click(l_param,scope.showResource)}if($.makeArray(p_data.hotspots.item).length<1){this.decisionsComplete()}},hideDecisionButtons:function(){$("#decision-navigation").find("a").unbind("click").hide()},showFeedback:function(p_hotspot){var scope=this;_app.$feedback.find(".feedback-button").unbind("click");if(p_hotspot.feedback){$("#background-image").addClass("disabled");_app.$feedback.find("#feedback-txt").html("<h4>"+p_hotspot.title+"</h4>"+p_hotspot.feedback);_app.$feedback.find(".btn-feedback-restart").show().click(scope.restartDecision);_app.$feedback.find(".btn-feedback-undo").show().click(scope.undoDecision);if(p_hotspot.resource){var l_param={resource:p_hotspot.resource};_app.$feedback.find(".btn-feedback-more").show().click(l_param,scope.showResource)}if(p_hotspot.link){this.linkClicked=p_hotspot.link;_app.$feedback.find(".btn-feedback-continue").show().click(scope.continueDecision)}else{this.decisionsComplete()}_app.$feedback.find("#feedback-content").removeAttr("style");_app.$feedback.fadeIn(function(){_app.$feedback.findFirstText().attr({tabindex:"-1"}).focus()});_app.$blocker.fadeIn()}else if(p_hotspot.link){this.linkClicked=p_hotspot.link;var l_fakeEvent={preventDefault:function(){}};scope.continueDecision(l_fakeEvent)}},getDecisionPointData:function(p_id){var l_decisionPoints=$.makeArray(_app.currentPage.data.decision_points.item),l_count=l_decisionPoints.length;for(var i=0;i<l_count;i++){if(p_id==l_decisionPoints[i].id){return l_decisionPoints[i]}}return false},restartDecision:function(p_event){_app.session.setUserData([_app.currentPage.id]);_app.sequence.goTo(_app.currentPage.id);p_event.preventDefault()},previousDecision:function(p_event){var l_previous="",l_decisionPoint={};_app.currentPage.userData.pop();l_previous=_app.currentPage.userData[_app.currentPage.userData.length-1];l_decisionPoint=_app.currentPage.getDecisionPointData(l_previous);_app.$feedback.trigger("hide");_app.$content.find("#background-image").fadeOut(600,function(){_app.currentPage.showDecisionPoint(l_decisionPoint)});p_event.preventDefault()},undoDecision:function(p_event){var l_decisionPoint=_app.currentPage.getDecisionPointData(_app.currentPage.decisionPoint),$image=_app.$content.find("#background-image");_app.$feedback.trigger("hide");$image.removeClass("disabled");$image.find(".selected").removeClass("selected");_app.currentPage.showIntroText(l_decisionPoint);p_event.preventDefault()},continueDecision:function(p_event){var l_decisionPoint=_app.currentPage.getDecisionPointData(_app.currentPage.linkClicked);_app.$feedback.trigger("hide");_app.$content.find("#background-image").fadeOut(600,function(){_app.currentPage.showDecisionPoint(l_decisionPoint)});p_event.preventDefault()},showResource:function(p_event){window.open("files/"+p_event.data.resource.item.content,"_blank");p_event.preventDefault()},decisionsComplete:function(){$("#btn-page-navigation-next").enable();_app.$feedback.find(".interactivity-dt .btn-feedback-next").show().click(function(p_event){_app.sequence.next();p_event.preventDefault()});this.updatePageData([-1,this.userData,1])}});