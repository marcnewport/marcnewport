var mp_free_text=PageType.extend({setup:function(){this.layout="scenario-left";this.playerId="page-media-"+$.randomString(6);this.$scenario=$$("div","scenario").html(this.data.scenario);this.$media=$$("div",this.playerId,"page-media");this.$leftColumn=$$("div","","left-column");this.$rightColumn=$$("div","","inner-wrap");this.hasMedia=this.data.media?true:false;var l_questions=$.makeArray(this.data.questions.question),l_questionCount=l_questions.length,l_comments=_app.session.getComments(this.id),l_comment="",l_classes="";if(this.hasMedia){this.layout="scenario-right";this.$leftColumn.append(this.$media);if(!empty(this.data.scenario)){this.$rightColumn.append(this.$scenario)}}else{this.$leftColumn.append(this.$scenario)}for(var i=0;i<l_questionCount;i++){l_comment=l_comments[i]||"Enter text here";l_classes=i+1==l_questionCount?"question last":"question";this.$rightColumn.append($$("div","",l_classes).html($$("label").attr("for","textarea-"+i).html(l_questions[i].text[0])).append($$("textarea","textarea-"+i,"freetext").val(l_comment.carriage())))}_app.$content.addClass(this.layout);this.html.append(this.$leftColumn).append($$("div","","right-column").append(this.$rightColumn).append($$("a","btn-submit").attr({href:"#",role:"button"}).html("Submit")));this._super()},pageReady:function(){this._super();var scope=this,l_questions=$.makeArray(this.data.questions.question),l_questionCount=l_questions.length||1,l_limit=4e3/l_questionCount,$textarea=this.$rightColumn.find("textarea"),l_dimensions={},l_description="",l_media=this.data.media,l_dimensions={},l_maxMediaWidth=385,l_maxMediaHeight=_app.$content.find(".inner").eq(0).height()-_app.$content.find(".page-title").height(),n_width=0,n_height=0;if(l_media){l_media=this.data.media.item;l_dimensions={width:l_media.width,height:135};switch(l_media.type){case"mp_resource_video":l_media.width=l_maxMediaWidth;l_media.height=Math.floor(l_media.width*(9/16));_app.setupVideoPlayer(this.playerId,l_media);break;case"mp_resource_audio":l_media.width=l_maxMediaWidth;l_media.height=Math.floor(l_media.width*(9/16));if(!l_media.image){l_media.height=24;l_dimensions.height=350}_app.setupAudioPlayer(this.playerId,l_media,l_media.image);break;case"mp_resource_image":l_media=this.data.media.item;if(l_media.width>l_media.height){n_width=l_maxMediaWidth;n_height=l_media.height/l_media.width*n_width}else{n_height=l_maxMediaHeight;n_width=l_media.width/l_media.height*n_height}this.$media.css({width:n_width}).html($$("img").attr({src:"files/"+l_media.content,alt:l_media.alt_text||""}).css({width:n_width,height:n_height}));break}l_description=this.data.description||l_media.description||"";if(!empty(l_description)&&l_media.type!="mp_resource_image"){this.$leftColumn.append($$("div").html(l_description).transcript("down",l_dimensions,this.playerId))}this.resizePage()}$("#btn-submit").disable();if($textarea.length===1){$textarea.height(180)}this.$rightColumn.find("textarea").each(function(){var $this=$(this);$this.focus(function(){if($this.val()=="Enter text here"){$this.val("")}}).keyup(function(){var l_text=$this.val();if(l_text.length>l_limit){$this.val(l_text.substr(0,l_limit))}scope.submitable()}).blur(function(){var l_text=$this.val();if(l_text==""){$this.val("Enter text here");return}else if(l_text.length>l_limit){$this.val(l_text.substr(0,l_limit))}})})},submitable:function(){var $textareas=this.$rightColumn.find("textarea"),l_count=$textareas.length,l_submitable=true;for(var i=0;i<l_count;i++){switch($textareas.eq(i).val()){case"":case"Enter text here":l_submitable=false;break}}if(l_submitable){$("#btn-submit").enable()}else{$("#btn-submit").disable()}},resizePage:function(){var $pageTitle=_app.$content.find(".page-title"),$inner=_app.$content.find(".inner").eq(0),l_margin=$inner.outerHeight(true)-$inner.outerHeight(),l_outer=$pageTitle.outerHeight(true)+l_margin,$leftColumn=_app.$content.find(".left-column"),lc_margin=parseInt($leftColumn.css("margin-bottom"),10),$rightColumn=_app.$content.find(".right-column"),rc_margin=parseInt($rightColumn.css("margin-bottom"),10),$rightInner=$rightColumn.find(".inner-wrap"),l_height=_app.$content.height(),l_submit=_app.$content.find("#btn-submit").outerHeight(),y_margin=$inner.outerWidth(true)-$inner.outerWidth(),l_width=_app.$content.width(),$pageMedia=$inner.find(".page-media");switch(this.layout){case"scenario-left":$leftColumn.css({maxHeight:l_height-l_outer-lc_margin,overflow:"auto",paddingRight:"10px"});break;case"scenario-right":if(this.hasMedia){if(!$pageMedia.length)$pageMedia=$inner.find(".jwplayer-wrap");$leftColumn.css("width",$pageMedia.width());$rightColumn.css("width",l_width-y_margin-$pageMedia.width()-25)}else{$rightColumn.css({width:l_width-y_margin-$pageMedia.width()})}break}$rightInner.css({maxHeight:l_height-l_outer-l_submit-rc_margin-15,overflow:"auto",paddingRight:"15px",marginBottom:"15px"});$rightInner.find("textarea").css({width:$rightInner.width()-55})},submitAnswers:function(){var l_userData=[];_app.pausePlayers();$("#btn-submit").disable();$(".freetext").attr("disabled","true");this.$rightColumn.find("textarea").each(function(){var l_input=this.value;if(l_input==="Enter text here"||l_input===""){l_input="No comment."}l_userData.push(l_input.uncarriage())});_app.session.setComments(this.id,l_userData);this.updatePageData([1,[]])},resetActivity:function(){$(".freetext").removeAttr("disabled");$("#btn-submit").enable()}});