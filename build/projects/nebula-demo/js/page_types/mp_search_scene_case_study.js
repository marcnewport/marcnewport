var mp_search_scene_case_study=mp_search_scene.extend({setup:function(){var scope=this,l_image=this.data.asset.item,l_hotspots=$.makeArray(this.data.hotspots.item),l_hsCount=l_hotspots.length,$image=$$("img").attr({src:"files/"+l_image.content,alt:l_image.alt_text+" Select each clickable within the image.",width:l_image.width,height:l_image.height}),l_userData=_app.session.getUserData(this.id),l_class="",l_csTabIndex=0;this.$scene=$$("div","scene-case-study").attr({role:"listbox"});this.$scene.append($image);for(var i=0;i<l_hsCount;i++){l_hotspots[i].id="hscs-"+i;l_hotspots[i].viewed=false;l_class="hotspot";if(l_userData[2]!=undefined&&Boolean(l_userData[2][i])){l_class+=" complete";l_hotspots[i].viewed=true}this.$scene.append($$("a",l_hotspots[i].id,l_class,{href:"#",role:"option"}).css({position:"absolute",top:l_hotspots[i].top+"px",left:l_hotspots[i].left+"px"}).html(l_hotspots[i].title))}this.hotspots=l_hotspots;this.html.append($$("div","main-text").html(this.data.main)).append(this.$scene);this.hotspotId="";l_csTabIndex=_app.structure.parent(_app.structure.parent(this.data.id).id).id;_app.panels.case_study.$panel.find("#tab-content-"+l_csTabIndex).find(".tab-sub-content").html(this.html.wrapInner($$("div","","inner")));setTimeout(function(){scope.pageReady()},10)},resizePage:function(){var scope=this,$container=$("#"+this.id),$pageTitle=$container.find(".page-title"),$inner=$container.find(".inner"),l_margin=$inner.outerHeight(true)-$inner.outerHeight(),l_outer=$pageTitle.actual("height")+l_margin,$main=$container.find("#main-text"),$scene=$container.find("#scene-case-study"),$csTab=[],$csPanel=[],l_buttonMargin=30,l_padding=15,l_height=$container.actual("height"),l_width=$container.find(".inner").actual("width"),$img=$scene.find("img"),l_imageWidth=$img.width(),l_imageHeight=0,l_availableWidth=0,l_availableHeight=0;$csPanel=_app.panels.case_study.$panel.find(".panel-content");$csTab=$("#tab-content-"+_app.panels.case_study.tab);l_height=$csPanel.css("max-height").split("px")[0];l_imageHeight=$img.height();if($csTab.hasClass("has-buttons")){l_width=$csPanel.width()-$csTab.find(".tab-buttons").width()-l_buttonMargin}$csTab.find(".tab-sub-content").width(l_width);l_availableWidth=l_width-l_imageWidth-40-l_padding*2;l_availableHeight=l_height-l_outer-10;if(l_availableWidth>90){$main.css({width:l_availableWidth,paddingRight:l_padding+"px","float":"",marginRight:l_padding+"px"});if(l_imageHeight<l_availableHeight){$main.height(l_availableHeight)}$scene.css({"float":"",marginTop:""});$csTab.find(".content-wrap").css({width:"98%",height:l_availableHeight,"overflow-y":"auto",paddingRight:"2%"}).scroll(function(){$csTab.find("#hs-popup").fadeOut(400,function(){scope.hotspotId="";$(this).remove()})})}else{$csTab.find(".content-wrap").css({width:"95%",height:l_height-l_outer-10,"overflow-y":"auto",paddingRight:"5%"}).scroll(function(){$csTab.find("#hs-popup").fadeOut(400,function(){scope.hotspotId="";$(this).remove()})});$main.css({width:"auto","float":"none",paddingRight:"",maxHeight:"auto",overflow:"visible"});$scene.css({width:"auto","float":"none",marginTop:l_padding+"px"})}},hotspotClicked:function(p_id){var scope=this,l_hsCount=this.hotspots.length,l_hotspot={};for(var i=0;i<l_hsCount;i++){if(this.hotspots[i].id==p_id){this.hotspots[i].viewed=true;l_hotspot=this.hotspots[i];break}}$("#"+this.id).find("#hs-popup").remove();this.popup(l_hotspot);setTimeout(function(){scope.submit()},400)},popup:function(p_data){var scope=this,$container=$("#"+this.id),$hotspot=$("#"+this.hotspotId),$popup=$$("div","hs-popup","hidden popup",{role:"dialog"}),l_title=p_data.title||"&nbsp;",l_content=p_data.label||"&nbsp;",$close=$$("a","btn-close-popup").attr({href:"#",role:"button"}).html("Close"),l_width=0,l_height=0,l_scrollTop=0,c_offset=0,s_offset=0,l_difference=0,hs_position=0,l_middle=0,l_top=0,l_left=0,l_bottom=0;$popup.html($$("div","","title").append($$("div","","inner").html($$("h3").html(l_title)))).append($$("div","","content").html(l_content));$container.append($popup);l_width=$popup.actual("width");l_height=$popup.actual("height");$container=$container.parent();l_scrollTop=$container.scrollTop();c_offset=$container.offset();s_offset=$("#scene-case-study").offset();l_difference=s_offset.top-c_offset.top;hs_position=$hotspot.position();l_middle=(l_height-$hotspot.outerHeight())/2;l_top=l_difference+hs_position.top-l_middle+l_scrollTop;l_left=hs_position.left-l_width;l_bottom=$container.height();if(l_top+l_height+5>l_bottom+l_scrollTop){l_top=l_bottom-l_height-5}if(l_top<5){l_top=5}if(l_left<5){l_left=hs_position.left+$hotspot.outerWidth()-2}$popup.css({top:Math.round(l_top)+"px",left:Math.round(l_left)+"px"});$popup.fadeIn(400,function(){$popup.findFirstText().attr({tabindex:"-1"}).focus();$close.bind("click.closePopup",function(e){$popup.trigger("closePopup");$close.unbind("click.closePopup");e.preventDefault()});$(document).bind("keyup.closePopup",function(e){if(e.keyCode==27){$popup.trigger("closePopup");$(document).unbind("keyup.closePopup");e.preventDefault()}});$container.bind("click.closePopup",function(e){$popup.trigger("closePopup");_app.$content.unbind("click.closePopup");e.preventDefault()});$popup.bind("closePopup",function(){$popup.fadeOut(400,function(){$("#"+p_data.id).focus();$(this).remove()});scope.hotspotId="";$container.unbind("closePopup")})})}});