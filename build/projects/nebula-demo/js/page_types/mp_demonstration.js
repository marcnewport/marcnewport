var mp_demonstration=PageType.extend({setup:function(){this.audio=new Audio;this.transcript=false;this.positionIndex=0;var l_userData=_app.session.getUserData(this.id)[2]||[],l_dataCount=l_userData.length,$img=$$("img"),$intro="",$navigation=$$("div","navigation-wrap","hidden"),$list=$$("ul"),l_positions=$.makeArray(this.data.positions.item),l_count=l_positions.length;for(var i=0;i<l_dataCount;i++){if(l_userData[i]>1)this.positionIndex=i}$img.attr({src:"files/"+this.data.image.item.content,alt:this.data.image.item.alt_text}).css({width:this.data.image.item.width,height:this.data.image.item.height});if(this.data.introduction&&!l_dataCount){$intro=$$("div","introduction").attr({tabIndex:0,role:"dialog"}).append($$("div","","content").html(this.data.introduction)).append($$("a","btn-start").attr({href:"#",role:"button"}).html("Start"))}for(var j=0;j<l_count;j++){$list.append($$("li").append($$("a","item-"+j,"navigation-button").attr({href:"#",role:"button",title:l_positions[j].label}).html(l_positions[j].label||"")));if(l_positions[j].audio.item&&l_positions[j].audio.item.description){this.transcript=true}}this.html.append($$("div","stage").attr({role:"widget"}).append($$("div","stage-blocker")).append($img).append($intro).append($$("a","btn-pause","hidden").attr({href:"#",role:"button","aria-live":"polite"}).append($$("i","","icon icon-pause")).append($$("span").html("Pause"))).append($$("div","position-back").html($$("i","","icon icon-chevron-straight-left"))).append($$("div","position-next").html($$("i","","icon icon-chevron-straight-right"))).append($navigation.append($list)));this._super()},pageReady:function(){this._super();var scope=this,l_userData=_app.session.getUserData(this.id)[2]||0,$stage=_app.$content.find("#stage"),$blocker=$stage.find("#stage-blocker"),$navigation=$stage.find("#navigation-wrap"),$pause=$stage.find("#btn-pause");scope.updatePosition(scope.positionIndex);if(l_userData){$navigation.fadeIn();scope.resizePage();if(scope.audio.src!==""){scope.pauseAudio();$pause.show()}$blocker.fadeOut(function(){$stage.addClass("ready")})}else{_app.$content.find("#btn-start").bind("click",function(p_event){$stage.addClass("ready");_app.$content.find("#introduction").fadeOut(function(){$pause.focus();$(this).remove();scope.updatePosition(0)});$blocker.fadeOut();$navigation.fadeIn();scope.resizePage();p_event.preventDefault()})}$stage.find("#position-next").bind("click",function(p_event){scope.updatePosition(scope.positionIndex+1);p_event.preventDefault()});$stage.find("#position-back").bind("click",function(p_event){scope.updatePosition(scope.positionIndex-1);p_event.preventDefault()});$navigation.bind("click",function(p_event){var l_index=Number(p_event.target.id.split("-").pop());if(!isNaN(l_index))scope.updatePosition(l_index);p_event.preventDefault()});$pause.bind("click",function(p_event){if(scope.audio.paused){scope.playAudio()}else{scope.pauseAudio()}p_event.preventDefault()})},playAudio:function(){_app.$content.find("#btn-pause").find("span").html("Pause").end().find(".icon").removeClass("icon-play").addClass("icon-pause");this.audio.play()},pauseAudio:function(){_app.$content.find("#btn-pause").find("span").html("Play").end().find(".icon").removeClass("icon-pause").addClass("icon-play");this.audio.pause()},updatePosition:function(p_index){var scope=this,l_userData=_app.session.getUserData(this.id)[2]||[],l_completed=1,$inner=_app.$content.find(".inner").eq(0),$stage=$inner.find("#stage"),l_ready=$stage.hasClass("ready"),$pause=$stage.find("#btn-pause"),$img=$stage.find("img"),l_positions=$.makeArray(this.data.positions.item),l_count=l_positions.length,l_width=0,l_height=0,l_position=0,l_left=0,l_top=0;if(!l_positions[p_index])return;l_width=Math.round(this.data.image.item.width*l_positions[p_index].zoom);l_height=Math.round(this.data.image.item.height*l_positions[p_index].zoom);l_position=l_positions[p_index].position.split(",");l_left=Number(l_position[0]);l_top=Number(l_position[1]);if(l_positions[p_index].audio.item){this.audio.src="files/"+l_positions[p_index].audio.item.content;if(Number(this.data.autoplay)){this.audio.onended=function(){scope.updatePosition(scope.positionIndex+1)}}else{this.audio.onended=function(){scope.pauseAudio()}}if(l_ready){$pause.show();this.playAudio()}}else{$pause.hide();this.pauseAudio()}$img.css({width:l_width,height:l_height,marginLeft:"-"+l_left+"px",marginTop:"-"+l_top+"px"});$("#navigation-wrap").find(".navigation-button").each(function(i){if(i===p_index){$(this).addClass("selected")}else{$(this).removeClass("selected")}});if(l_positions[p_index].audio.item&&l_positions[p_index].audio.item.description){if($inner.find(".transcript").length){$inner.find(".transcript").removeClass("hidden").find(".transcript-content").html(l_positions[p_index].audio.item.description)}else{$inner.append($$("div").html(l_positions[p_index].audio.item.description).transcript("right",{width:260,height:$stage.height()},"demo"))}}else{$inner.find(".transcript").addClass("hidden")}this.positionIndex=p_index;for(var i=0;i<l_count;i++){if(l_userData[i]>1){l_userData[i]=1}if(!l_userData[i]){l_userData[i]=0}}l_userData[p_index]=2;this.updatePageData([-1,l_userData,1,l_completed]);for(var i=0;i<l_count;i++){if(l_userData[i]===0){l_completed=0}}if(l_completed){this.updatePageData([-1,l_userData,1,l_completed]);_app.$page.find("#btn-page-navigation-next").enable()}},resizePage:function(){var $inner=_app.$content.find(".inner").eq(0),$title=$inner.find(".page-title"),$stage=$inner.find("#stage"),l_height=$inner.height()-$title.height(),l_width=$inner.width(),$intro=$inner.find("#introduction"),$navigation=$("#navigation-wrap"),l_left=Math.round(($stage.width()-$navigation.width())/2);if(this.transcript){l_width-=260}$stage.css({height:l_height,width:l_width,overflow:"hidden"});$navigation.css({left:l_left});$intro.css({left:Math.round(($stage.width()-$intro.width())/2),top:Math.round(($stage.height()-$intro.height())/2)})}});