var Scorm=Class.extend({init:function(){this.API=null;this.connected=false;this.connectAttempts=0;this.maxAttempts=5;this.writeAccess=false;var l_cache={};this.cache=function(l_item,l_data){if(l_data!=undefined){l_cache[l_item]=l_data}else{return l_cache[l_item]}}},connect:function(p_callback){var l_scope=this,l_api=null,l_maxCrawls=7,l_windows=[window,window.opener],l_window={};for(var a in l_windows){l_window=l_windows[a];if(l_window!=null){for(var i=0;i<l_maxCrawls;i++){if(l_window.API!=null){l_api=l_window.API;break}else if(l_window.parent!=null&&l_window.parent!=l_window){l_window=l_window.parent}}}}if(l_api!=null){if(l_api.LMSInitialize("")=="true"){this.API=l_api;this.connected=true;this.writeAccess=true}}if(this.connected){if(p_callback)p_callback()}else{if(this.connectAttempts<this.maxAttempts){setTimeout(function(){l_scope.connectAttempts++;l_scope.connect(p_callback)},500)}else{this.error();if(p_callback)p_callback()}}},send:function(p_key,p_value){var l_value,l_result;if(this.connected&&this.writeAccess){l_value=p_value;if(typeof l_value=="object"){l_value=JSON.stringify(l_value);l_value=l_value.split("~").join("&#126;");l_value=l_value.split('"').join("~")}l_result=this.API.LMSSetValue(p_key,l_value);if(l_result!="true"){this.error()}}},commit:function(){if(this.connected&&this.writeAccess){if(this.API.LMSCommit("")!="true"){this.error()}}},save:function(p_callback){var l_session=_app.session.data(),l_cache="",l_data="",l_dataSet=false;if(this.connected&&this.writeAccess){for(var item in l_session){if(item.split(".")[0]==="cmi"){if(item==="cmi.interactions._count")continue;l_data=l_session[item];l_cache=this.cache(item);if(typeof l_data==="object"){l_data=JSON.stringify(l_data);l_data=l_data.split("~").join("&#126;");l_data=l_data.split('"').join("~")}if(l_cache===undefined){if(l_data==="")continue}else{if(l_cache===l_data)continue}this.send(item,l_data);this.cache(item,l_data);l_dataSet=true}}if(l_dataSet){this.commit()}}if(p_callback){setTimeout(function(){p_callback()},250)}},retrieve:function(p_key){var l_result;if(this.connected){l_result=this.API.LMSGetValue(p_key);if(typeof l_result==="string"){if(p_key==="cmi.comments"){l_result=l_result.replace(/\]\[/g,"],[");l_result="["+l_result+"]"}if(l_result.indexOf("{")===0||l_result.indexOf("[")===0){l_result=l_result.split("~").join('"');l_result=l_result.split("&#126;").join("~");l_result=JSON.parse(l_result)}}return l_result}return false},retrieveAll:function(p_callback){var l_data="",l_fields=[],l_fieldCount=0,l_objCount=0,l_objFields=[],l_objFieldsCount=0,l_success=false;if(this.connected){l_fields=["cmi.core.lesson_location","cmi.core.lesson_status","cmi.core.score.raw","cmi.core.score.max","cmi.suspend_data","cmi.interactions._count"];l_fieldCount=l_fields.length;for(var i=0;i<l_fieldCount;i++){l_data=this.retrieve(l_fields[i]);if(l_data!==""){_app.session.set(l_fields[i],l_data);this.cache(l_fields[i],l_data)}}l_objCount=this.retrieve("cmi.objectives._count");for(var j=0;j<l_objCount;j++){l_objFields=["cmi.objectives."+j+".id","cmi.objectives."+j+".status","cmi.objectives."+j+".score.raw","cmi.objectives."+j+".score.min","cmi.objectives."+j+".score.max"];l_objFieldsCount=l_objFields.length;for(var k=0;k<l_objFieldsCount;k++){l_data=this.retrieve(l_objFields[k]);if(l_data!=""){_app.session.set(l_objFields[k],l_data);this.cache(l_objFields[k],l_data)}}}l_data=this.retrieve("cmi.comments");if(l_data!==""){_app.session.set("comments",l_data)}l_success=true}if(p_callback!=undefined){setTimeout(p_callback,1e3)}return l_success},disconnect:function(){this.writeAccess=false;this.enableBrowserWarning(false)},close:function(){var scope=this,l_exit="suspend";if(this.connected){if(!_app.session.resume){if(empty(_app.session.get("cmi.core.score.raw"))){_app.session.set("cmi.core.score.raw","0");_app.session.set("cmi.core.score.max","100");_app.session.set("cmi.core.score.min","0")}l_exit=""}_app.session.set("cmi.core.exit",l_exit);this.save(function(){scope.enableBrowserWarning(false);scope.connected=false;if(scope.API.LMSFinish("")!="true"){scope.error()}})}},error:function(){var l_code="",l_description="";if(this.connected){l_code=this.API.LMSGetLastError(),l_description=this.API.LMSGetDiagnostic(l_code);trace("LMS ERROR "+l_code+": "+l_description,2)}},retrieveObjectiveData:function(p_topic){var l_identifier="",l_objectiveCount=0,l_found=false,l_data=false,l_raw=0,l_max=0,l_percent=0;if(this.connected){l_identifier=p_topic.title.truncate(250,p_topic.id);l_objectiveCount=this.retrieve("cmi.objectives._count");for(var i=0;i<l_objectiveCount;i++){if(this.retrieve("cmi.objectives."+i+".id")==l_identifier){l_found=true;break}}if(l_found){l_raw=Number(this.retrieve("cmi.objectives."+i+".score.raw"));l_max=Number(this.retrieve("cmi.objectives."+i+".score.max"));l_percent=l_raw/l_max*100;l_percent=Math.round(l_percent*100)/100;l_percent=isNaN(l_percent)?0:l_percent;l_data={id:this.retrieve("cmi.objectives."+i+".id"),status:this.retrieve("cmi.objectives."+i+".status"),score:{raw:l_raw,max:l_max,percent:l_percent}}}}return l_data},enableBrowserWarning:function(p_enable){var scope=this;if(p_enable){window.onbeforeunload=function(){scope.API.LMSCommit("");scope.API.LMSFinish("");alert("You have ended your session.")}}else{window.onbeforeunload=null}}});