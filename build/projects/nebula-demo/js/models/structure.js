var Structure=Class.extend({init:function(){this.course={}},build:function(p_callback){var l_cacheBuster="?cacheBuster="+$.randomString(),l_xmlPath="./data/structure.xml"+l_cacheBuster,scope=this;$.ajax({type:"GET",url:l_xmlPath,dataType:"xml",success:function(p_data){var l_data=$.xml2json(p_data);scope.course=l_data.course;l_data=null;if(p_callback!=undefined){setTimeout(p_callback,1e3)}return true},error:function(p_response,p_status,p_error){trace('Could not load "'+l_xmlPath+'"\r\n'+p_status+": "+p_error.name);return false}})},viewable:function(p_id){var l_id=p_id||_app.currentPage.id,l_item=this.find(l_id),l_viewables=this.course.settings.viewable.split(","),l_viewCount=l_viewables.length;if(typeof l_item==="object"){for(var i=0;i<l_viewCount;i++){if(l_viewables[i]==l_item.type){return true}}}return false},find:function(p_id,p_depth){var l_id=p_id||_app.currentPage.id,l_items=$.makeArray(p_depth||this.course.tree.item),l_itemCount=l_items.length;for(var i=0;i<l_itemCount;i++){if(l_items[i].id==l_id){return l_items[i]}else if(typeof l_items[i].children==="object"){var l_child=this.find(l_id,l_items[i].children.item);if(typeof l_child==="object"){return l_child}}}return false},findFirstOfType:function(p_type,p_depth){var l_items=$.makeArray(p_depth||this.course.tree.item),l_itemCount=l_items.length;for(var i=0;i<l_itemCount;i++){if(l_items[i].type==p_type){return l_items[i]}else if(typeof l_items[i].children==="object"){var l_child=this.findFirstOfType(p_type,l_items[i].children.item);if(typeof l_child==="object"){return l_child}}}return false},first:function(p_depth){var l_items=$.makeArray(p_depth||this.course.tree.item),l_itemCount=l_items.length;for(var i=0;i<l_itemCount;i++){if(this.viewable(l_items[i].id)){return l_items[i]}else if(typeof l_items[i].children==="object"){var l_child=this.first(l_items[i].children.item);if(typeof l_child==="object"){return l_child}}}return false},last:function(){var l_item=this.course.tree.item,l_itemCount=l_item.length-1;for(var i=l_itemCount;i>-1;i--){if(this.viewable(l_item[i].id)){return l_item[i]}}return false},firstViewableChild:function(p_id,p_depth){var l_id=p_id||_app.currentPage.id,l_items=$.makeArray(p_depth||this.course.tree.item),l_itemCount=l_items.length;for(var i=0;i<l_itemCount;i++){if(l_items[i].id==l_id){var l_childItem=l_items[i];if(typeof l_childItem.children==="object"){var l_childItems=$.makeArray(l_childItem.children.item),l_childItemCount=l_childItems.length;for(var j=0;j<l_childItemCount;j++){if(this.viewable(l_childItems[j].id)){return l_childItems[j]}}}}else if(typeof l_items[i].children==="object"){var l_child=this.firstViewableChild(l_id,l_items[i].children.item);if(typeof l_child==="object"||l_child=="last"){return l_child}}}return false},lastViewableChild:function(p_id,p_depth){var l_id=p_id||_app.currentPage.id,l_items=$.makeArray(p_depth||this.course.tree.item),l_itemCount=l_items.length,l_childItem={},l_childItems=[],l_childItemCount=0,l_child;for(var i=0;i<l_itemCount;i++){if(l_items[i].id==l_id){l_childItem=l_items[i];if(typeof l_childItem.children==="object"){l_childItems=$.makeArray(l_childItem.children.item);l_childItemCount=l_childItems.length-1;for(var j=l_childItemCount;j>=0;j--){if(this.viewable(l_childItems[j].id)){return l_childItems[j]}}}}else if(typeof l_items[i].children==="object"){l_child=this.lastViewableChild(l_id,l_items[i].children.item);if(typeof l_child==="object"||l_child=="last"){return l_child}}}return false},parent:function(p_id,p_depth,p_parent){var l_id=p_id||_app.currentPage.id,l_items=$.makeArray(p_depth||this.course.tree.item),l_parent=p_parent||this.course,l_itemCount=l_items.length;for(var i=0;i<l_itemCount;i++){if(l_items[i].id==l_id){return l_parent}else if(typeof l_items[i].children==="object"){var l_child=this.parent(l_id,l_items[i].children.item,l_items[i]);if(typeof l_child==="object"||l_child=="last"){return l_child}}}return false},next:function(p_id){var l_id=p_id||_app.currentPage.id,l_parent=this.parent(l_id),l_structure=l_parent.tree?l_parent.tree:l_parent.children,l_siblings=$.makeArray(l_structure.item),l_siblingCount=l_siblings.length,l_next={};for(var i=0;i<l_siblingCount;i++){if(l_siblings[i].id==l_id){if(i<l_siblingCount-1){l_next=l_siblings[i+1];if(this.viewable(l_next.id)){return l_next}else{return this.next(l_next.id)}}else{return"last"}break}}return false},previous:function(p_id){var l_id=p_id||_app.currentPage.id,l_parent=this.parent(l_id),l_structure=l_parent.tree?l_parent.tree:l_parent.children,l_siblings=$.makeArray(l_structure.item),l_siblingCount=l_siblings.length,l_previous={};for(var i=0;i<l_siblingCount;i++){if(l_siblings[i].id==l_id){if(i<1){return"first"}else{l_previous=l_siblings[i-1];if(this.viewable(l_previous.id)){return l_previous}else{return this.previous(l_previous.id)}}break}}return false},type:function(p_id){var l_item=this.find(p_id);if(typeof l_item==="object"){return l_item.type}return false},children:function(p_id,p_depth){var l_id=p_id||_app.currentPage.id,l_items=$.makeArray(p_depth||this.course.tree.item),l_itemCount=l_items.length;for(var i=0;i<l_itemCount;i++){if(l_items[i].id==l_id){if(typeof l_items[i].children==="object"){var l_childs=[],l_children=l_items[i].children.item,l_childCount=l_children.length;for(var j=0;j<l_childCount;j++){l_childs[j]=l_children[j].id}return l_childs}}else if(typeof l_items[i].children==="object"){var l_child=this.children(l_id,l_items[i].children.item);if(l_child instanceof Array){return l_child}}}return false},getTopics:function(){var l_items=this.course.tree.item,l_itemCount=l_items.length,l_role=_app.session.getUserData("role")[1]||false,l_allowedRoles=[],l_topics=[];for(var i=0;i<l_itemCount;i++){if(l_items[i].type==="mp_topic"){if(l_role&&l_items[i].roles){l_allowedRoles=l_items[i].roles.split(",");if($.inArray(l_role,l_allowedRoles)<0){continue}}l_topics.push(l_items[i])}}return l_topics},getPosition:function(p_id){var l_id=p_id||_app.currentPage.id,l_role=_app.session.getUserData("role")[1]||"all",l_items=_app.structure.course.settings.page_list[l_role].replace(/\s/g,"").split(","),l_count=l_items.length,l_item={},l_position=[];for(var i=0;i<l_count;i++){l_item=this.find(l_items[i]);switch(l_item.type){case"mp_splash":l_items.splice(i,1);l_count--;break}}l_position.push(l_items.indexOf(l_id)+1);l_position.push(l_items.length);return l_position},getCaseStudy:function(){var l_items=$.makeArray(this.course.tree.item),l_itemCount=l_items.length;for(var i=0;i<l_itemCount;i++){if(l_items[i].type=="mp_case_study"){return l_items[i]}}return false},getNextTopic:function(){var l_allTopics=this.getTopics(),l_topics=[],l_count=0,l_currentTopic=this.parent().id,l_position=0;for(var a in l_allTopics){if(l_allTopics[a].children){l_topics.push(l_allTopics[a])}}l_count=l_topics.length;for(var i=0;i<l_count;i++){if(l_topics[i].id==l_currentTopic){l_position=i+1}}if(l_position<l_topics.length){return l_topics[l_position]}return false},getPreviousTopic:function(){var l_topics=this.getTopics(),l_count=l_topics.length,l_currentTopic=this.parent().id,l_position=0;for(var i=0;i<l_count;i++){if(l_topics[i].id==l_currentTopic){l_position=i-1;break}}if(l_position>-1){return l_topics[l_position]}return false}});