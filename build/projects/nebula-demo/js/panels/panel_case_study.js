var PanelCaseStudy=Panel.extend({init:function(){this.id="case-study";this.tab=0;this._super()},setup:function(p_data){this.data=_app.sequence.getData(p_data.id);this.structure=_app.structure.find(this.data.id);this.userData={};this.currentContentId="";if(empty(this.data))return;var $panel=this.$panel,$tabs=$panel.find(".panel-tabs"),$panelContent=$panel.find(".panel-content"),$contentPanel=[],$buttons=[],$tabContent=[],l_data=this.structure,l_tabChildren=l_data.children?$.makeArray(l_data.children.item):{},l_tabCount=l_tabChildren.length,l_tabData={},l_buttonEnabled=false,l_buttonUserData=false,l_buttons={},l_buttonCount=0,l_buttonWidth=0,l_buttonClass="",l_buttonMargin=30,l_tabClass="tab selected",l_contentClass="tab-content",l_firstContent={},l_firstContentData={},l_userData=_app.session.getUserData(this.data.id);if(!l_data.children)return;if(!l_userData)l_userData=[this.data.id,{}];for(var i=0;i<l_tabCount;i++){l_tabData=l_tabChildren[i];if(!l_userData[1][l_tabData.id])l_userData[1][l_tabData.id]={};if(i!==0){l_tabClass="tab";l_contentClass="tab-content hidden"}$contentPanel=$$("div","tab-content-"+l_tabData.id,l_contentClass);l_buttons=$.makeArray(l_tabData.children.item);l_buttonCount=l_buttons.length;$buttons=[];$tabContent=$$("div","","tab-sub-content");l_buttonWidth=0;if(l_buttonCount>1){$contentPanel.addClass("has-buttons");$buttons=$$("div","","tab-buttons");for(var b=0;b<l_buttonCount;b++){l_buttonEnabled=1;l_buttonUserData=l_userData[1][l_tabData.id][l_buttons[b].id];if(l_buttonUserData){l_buttonEnabled=Number(l_buttonUserData)}else{if(b!==0){l_buttonEnabled=Number(l_buttons[b].enabled)}l_userData[1][l_tabData.id][l_buttons[b].id]=Number(l_buttonEnabled)}l_buttonClass=Boolean(l_buttonEnabled)?"button":"button disabled";if(i===0&&b===0)l_buttonClass+=" selected";$buttons.append($$("a","button-"+l_buttons[b].children.item.id,l_buttonClass,{href:"#"}).html(l_buttons[b].title))}}else{l_userData[1][l_tabData.id][l_buttons[0].id]=1}$tabs.append($$("a","tab-"+l_tabData.id,l_tabClass,{href:"#"}).html(l_tabData.title));$panel.find(".panel-content").append($contentPanel.append($buttons).append($tabContent));if(l_buttonCount>1){l_buttonWidth=$contentPanel.find(".tab-buttons").actual("width")+10;$contentPanel.find(".tab-buttons").css({width:l_buttonWidth>150?150:l_buttonWidth+"px"});$contentPanel.find(".tab-sub-content").css({width:$panelContent.actual("width")-l_buttonWidth-l_buttonMargin+"px","float":"right"})}if(i===0){this.tab=l_tabData.id;l_firstContent=l_buttons[0].children.item;l_firstContentData=_app.sequence.getData(l_firstContent.id);this.newContent(l_firstContentData);l_userData[1].showing=l_userData[1][this.tab].showing=l_firstContent.id}}this.userData=l_userData;_app.session.setUserData(l_userData);this._super();this.ready()},ready:function(){var scope=this,$panel=this.$panel,$tabs=$panel.find(".panel-tabs"),l_tabId="",$tabContent=$panel.find(".tab-content"),$buttons=$panel.find(".tab-buttons"),$showTab=[],$showTabContent=[],l_id="",l_button={},l_data={};$tabs.click(function(p_event){var $target=$(p_event.target);if($target.hasClass("tab")){l_tabId=$target.attr("id").split("-").pop();$showTab=$panel.find("#tab-content-"+l_tabId);$showTabContent=$showTab.find(".tab-sub-content");$panel.find(".button").removeClass("active");$tabs.find(".tab").removeClass("selected");$target.addClass("selected");$tabContent.addClass("hidden");$showTab.removeClass("hidden");scope.tab=l_tabId;if($showTabContent.html()===""){l_button=$.makeArray(_app.structure.find(l_tabId).children.item)[0];if(Boolean(scope.userData[1][l_tabId][l_button.id])){l_id=l_button.children.item.id;l_data=_app.sequence.getData(l_id);$showTab.find("#button-"+l_id).addClass("selected");scope.newContent(l_data);scope.userData[1][scope.tab].showing=l_id}}scope.userData[1].showing=scope.userData[1][scope.tab].showing;if(_app.dimensions.layout=="fluid"){scope["caseStudyChild_"+scope.userData.showing].resizePage()}p_event.preventDefault()}});$buttons.click(function(p_event){var $target=$(p_event.target),l_classes=$target[0].className;if(l_classes.indexOf("button")>=0&&l_classes.indexOf("disabled")<0&&l_classes.indexOf("selected")<0){l_id=$target.attr("id").split("button-")[1];l_data=_app.sequence.getData(l_id);$buttons.find(".button").removeClass("selected");$target.addClass("selected");scope.newContent(l_data);scope.userData[1][scope.tab].showing=l_id;scope.userData[1].showing=l_id}p_event.preventDefault()});this._super();if(_app.dimensions.layout=="fluid"){$(window).resize(function(){scope["caseStudyChild_"+scope.userData[1].showing].resizePage()});setTimeout(function(){$(window).trigger("resize")},500)}},updateMediaPlayer:function(p_id){var l_playerId="case-study-"+$.randomString(6),$player=this.$panel.find("#case-study-player"),l_tabs=$.makeArray(this.data.tabs.item),l_media=l_tabs[p_id].media.item,$rightColumn=this.$panel.find(".panel-column-right"),$transcript=$rightColumn.find(".transcript");if(empty(l_media))return;$player.find(".jwplayer-wrap").remove();$player.prepend($$("div",l_playerId,"case-study-player"));l_media.width=372;l_media.height=210;switch(l_media.type){case"mp_resource_video":_app.setupVideoPlayer(l_playerId,l_media);break}if($transcript.length>0){$transcript.remove()}if(!empty(l_media.description)){$rightColumn.append($$("div").html(l_media.description).transcript("down",{width:372,height:130},l_playerId))}},open:function(){this._super();var scope=this,l_tab=0,l_tabs=$.makeArray(this.structure.children.item),l_btn=0;if(_app.currentPage.data.enable_cs_tab){if(_app.currentPage.data.enable_cs_tab!=="all"){l_tab=Number(_app.currentPage.data.enable_cs_tab)}}if(l_tabs[l_tab]){this.$panel.find("#tab-"+l_tabs[l_tab].id).trigger("click");setTimeout(function(){if(_app.currentPage.data.enable_cs_button){if(_app.currentPage.data.enable_cs_button!=="all"){l_btn=Number(_app.currentPage.data.enable_cs_button)}}scope.$panel.find("#tab-content-"+l_tabs[l_tab].id).find(".button").eq(l_btn).trigger("click")},500)}},close:function(p_callback){_app.removePlayers("case-study");this._super(p_callback);this.$panel.find("#cs-popup").remove()},newContent:function(p_data){if(p_data){var scope=this,l_data=p_data,l_type=l_data.type+"_case_study";$.loadScript("js/page_types/"+l_type+".js",function(){scope["caseStudyChild_"+l_data.id]=new window[l_type](l_data)})}},enableButton:function(p_data){if(empty(this.data))return;var l_data=p_data||[],l_tabIndex=l_data[0],l_btnIndex=l_data[1],l_btnNumber=Number(l_btnIndex),$tab=[],l_userData=_app.session.getUserData(this.data.id),l_structure=this.structure,l_tabChildren=l_structure.children?$.makeArray(l_structure.children.item):[],l_tabCount=l_tabChildren.length,l_buttonChildren=[],l_buttonCount=0,l_tabId="",l_btnId="";if(l_tabIndex=="all"){_app.panels.case_study.$panel.find(".button").removeClass("disabled")}else{$tab=_app.panels.case_study.$panel.find(".tab-content:nth-child("+(Number(l_tabIndex)+1)+")");if(l_btnIndex=="all"){$tab.find(".button").removeClass("disabled")}else{for(var i=0;i<=l_btnNumber;i++){$tab.find(".button:nth-child("+(i+1)+")").removeClass("disabled")}}}if(l_userData[1]){for(var t=0;t<l_tabCount;t++){l_tabId=l_tabChildren[t].id;l_buttonChildren=$.makeArray(l_tabChildren[t].children.item);l_buttonCount=l_buttonChildren.length;if(Number(l_tabIndex)==t||l_tabIndex=="all"){for(var b=0;b<l_buttonCount;b++){l_btnId=l_buttonChildren[b].id;if(l_btnNumber==b||l_btnIndex=="all"){l_userData[1][l_tabId][l_btnId]=1}}}}}}});