var PanelMenu=Panel.extend({init:function(){this.id="menu";this._super()},setup:function(){var $content=$$("ul","","content",{role:"tree"}),l_items=$.makeArray(_app.structure.course.tree.item),l_count=l_items.length,l_children=[],l_childCount=0,$topic=[],l_role=_app.session.getUserData("role")[1]||false,l_allowedRoles=[],$pages=[],l_pageClasses="",l_pageAttr={};for(var i=0;i<l_count;i++){switch(l_items[i].type){case"mp_introduction":$content.append($$("li").attr({role:"treeitem"}).append($$("a",l_items[i].id,"btn-page",{href:"#"}).html(l_items[i].title)));break;case"mp_topic":if(l_role&&l_items[i].roles){l_allowedRoles=l_items[i].roles.split(",");if($.inArray(l_role,l_allowedRoles)<0){continue}}l_children=l_items[i].children?$.makeArray(l_items[i].children.item):[];l_childCount=l_children.length;$topic=$$("li","topic-"+l_items[i].id,"topic",{role:"treeitem"}).append($$("a",l_items[i].id,"btn-topic",{href:"#","aria-expanded":"false"}).append(l_items[i].title));if(_app.structure.course.force_topics=="true"){$topic.addClass("disabled").find(".btn-topic").attr("tabindex","-1")}$pages=$$("ul","","pages",{role:"group"});for(var j=0;j<l_childCount;j++){l_pageClasses="page";l_pageAttr={role:"treeitem"};if(_app.structure.viewable(l_children[j].id)){if(!Number(_app.structure.course.settings.transition_page)&&l_children[j].type=="mp_transition"){continue}var l_userData=_app.session.getUserData(l_children[j].id);if(l_userData){switch(l_userData[1]){case-2:l_pageClasses+=" enabled";break;default:l_pageClasses+=" enabled complete";break}}else if(l_items[i].force_order=="true"){l_pageClasses+=" disabled";l_pageAttr["aria-disabled"]="true"}$pages.append($$("li","",l_pageClasses).attr(l_pageAttr).append($$("a",l_children[j].id,"btn-page",{href:"#"}).append($$("span","","icon-dot").html("●")).append(l_children[j].title)))}}$content.append($topic.append($pages));break}}this.$panel.find(".panel-content").html($content);this._super();this.ready()},ready:function(){var scope=this;this.$panel.unbind("click.panelmenu").bind("click.panelmenu",function(p_event){var $target=$(p_event.target),$parent=$target.parent(),l_pageId=$target.attr("id");p_event.preventDefault();if($target.hasClass("btn-topic")){if($parent.hasClass("disabled")){}else if($parent.hasClass("open")){$target.attr("aria-expanded","false").siblings(".pages").slideUp(function(){$parent.removeClass("open")})}else{$target.attr("aria-expanded","true").siblings(".pages").slideDown(function(){$parent.addClass("open")})}}else if($target.hasClass("btn-page")&&!$target.parent().hasClass("disabled")){switch(_app.navigation){case"hamburger":_app.currentPage.togglePanels();break;default:scope.close();break}_app.sequence.goTo(l_pageId)}})},open:function(){this._super();this.$panel.find(".topic").each(function(){var $topic=$(this),$page=[],l_complete=true,l_started=false;$topic.find(".page").each(function(){$page=$(this);if(!$page.hasClass("complete")){l_complete=false}else{l_started=true}});if(l_complete){$topic.addClass("complete").removeClass("disabled").find(".btn-topic").removeAttr("tabindex","-1")}else{$topic.removeClass("complete")}if(l_started){$topic.removeClass("disabled").find(".btn-topic").removeAttr("tabindex","-1")}})},pageComplete:function(p_id){var l_id=p_id;$("#"+l_id).parent().addClass("complete")},update:function(){this.$panel.find(".page").removeClass("current");this.$panel.find("#"+_app.currentPage.id).removeAttr("tabindex").parent().removeClass("disabled").removeAttr("aria-disabled").addClass("current enabled")}});